<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>百貨銷售報價單</title>
    <style>
        :root {--primary:#1e3a8a;--secondary:#4b5e7a;--accent:#3b82f6;--bg-light:#f8fafc;--bg-highlight:#f1f5f9;--text:#111827;--text-light:#6b7280;--border:#e5e7eb;--success:#15803d;--danger:#e53e3e}
        *{margin:0;padding:0;box-sizing:border-box;font-family:Arial,sans-serif}
        body{background-color:var(--bg-light);color:var(--text);line-height:1.5;font-size:14px}
        
        /* Layout */
        .container{max-width:1000px;margin:0 auto 20px;background-color:white;box-shadow:0 0 20px rgba(0,0,0,0.1)}
        .section{border-bottom:1px solid var(--border);margin-bottom:10px;padding-bottom:10px}
        
        /* Header */
        .header{background-color:var(--primary);color:white;padding:10px 20px;display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:0 !important;padding-bottom:0 !important;border-bottom:none !important}
        
        /* Logo */
        .company-logo{position:relative;cursor:pointer}
        .company-logo:hover{opacity:0.9}
        .company-logo:after{content:"點擊更換LOGO";position:absolute;bottom:-5px;right:0;font-size:10px;background-color:rgba(0,0,0,0.5);padding:2px 4px;border-radius:2px;opacity:0;transition:opacity 0.2s}
        .company-logo:hover:after{opacity:1}
        .company-logo img{max-height:50px;object-fit:contain}
        .upload-logo{position:absolute;width:0.1px;height:0.1px;opacity:0;z-index:-1}
        .company-info p{opacity:0.9;margin-bottom:2px;line-height:1.3}
        .default-logo-text{font-size:22px;font-weight:600;color:white}
        
        /* Document Title */
        .document-title h2{font-size:20px;font-weight:600;margin-bottom:2px;margin-left:-20px}
        .document-title p{color:rgba(255,255,255,0.9);margin-bottom:2px;line-height:1.3}
        
        /* Date Fields */
        .date-display{cursor:pointer;transition:opacity 0.2s;border-bottom:1px dashed rgba(0,0,0,0.3);padding-bottom:1px;background-color:transparent}
        .date-display:hover{opacity:0.8;border-bottom:1px dashed rgba(0,0,0,0.6)}
        .document-title .date-display,.document-title .editable-field{color:white;border-bottom:1px dashed rgba(255,255,255,0.5)}
        .document-title .date-display:hover{border-bottom:1px dashed rgba(255,255,255,0.8)}
        .hidden-date-input{position:absolute;opacity:0;width:1px;height:1px;overflow:hidden}
        .content .date-display{color:var(--text);border-bottom:1px dashed var(--accent);display:inline-block;min-width:120px}
        
        /* Info Sections */
        .quote-info{padding:8px 20px;display:grid;grid-template-columns:repeat(3,1fr);gap:15px;background-color:var(--bg-highlight)}
        #poNumber{display:inline-block;min-width:100px}
        
        /* Section Titles */
        .section-title,.section-title-with-controls{position:relative;padding-bottom:3px;height:22px;margin-bottom:4px !important;box-sizing:border-box}
        .section-title{font-size:15px;text-transform:uppercase;letter-spacing:1px;color:var(--primary);font-weight:600;display:flex;align-items:center}
        .section-title:after{content:'';position:absolute;left:0;bottom:0;width:36px;height:2px;background-color:var(--accent)}
        
        /* Info Groups */
        .info-group{margin-bottom:6px;overflow:visible}
        .info-group h4{font-size:14px;margin-bottom:3px;color:var(--text);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
        .info-group p{color:var(--text-light);margin-bottom:4px;line-height:1.4;word-wrap:break-word}
        .info-label{font-weight:600;display:inline-block;width:90px}
        .quote-meta-row{margin-bottom:2px;line-height:1.2}
        
        /* Editable Fields */
        [contenteditable=true],.editable-field{border-bottom:none;padding:1px;min-height:18px;min-width:80px;display:inline-block;color:var(--text);background-color:transparent}
        [contenteditable=true]:hover,.editable-field:hover{background-color:rgba(59,130,246,0.1)}
        [contenteditable=true]:focus,.editable-field:focus{outline:none;border-bottom:1px dashed var(--accent);background-color:rgba(59,130,246,0.1)}
        
        /* Items Section */
        .items-section{padding:10px 20px;background-color:white}
        .section-title-with-controls{display:flex;align-items:center;justify-content:space-between}
        .items-controls{display:flex;align-items:center;gap:5px;margin-left:10px}
        
        /* Buttons */
        .row-btn{background:none;border:none;cursor:pointer;font-size:18px;font-weight:bold;width:24px;height:24px;text-align:center;line-height:20px;transition:transform 0.2s;padding:0}
        .row-btn.add{color:var(--success)}
        .row-btn.delete{color:var(--danger)}
        .row-btn:hover{transform:scale(1.2)}
        
        /* Tables */
        table{width:100%;border-collapse:collapse;margin-top:6px;border:1px solid var(--border)}
        table th{background-color:var(--secondary);color:white;text-align:left;padding:5px;font-weight:600;border-bottom:2px solid var(--primary)}
        table td{padding:3px 5px;border-bottom:1px solid var(--border);vertical-align:middle}
        table tbody tr:hover{background-color:var(--bg-light)}
        .text-center{text-align:center}
        
        /* Input Fields */
        .input-field{width:100%;padding:2px;border:none;border-radius:2px;font-size:14px}
        .price-input{text-align:center !important;}
        .quantity-input,.shipping-input,.installation-input,.unit-input{text-align:center}
        .input-field:focus{outline:none;border-color:var(--accent)}
        .quantity-input::-webkit-inner-spin-button,.quantity-input::-webkit-outer-spin-button{-webkit-appearance:none;margin:0}
        .quantity-input{-moz-appearance:textfield;appearance:none}
        .original-price{text-decoration:line-through;color:var(--text-light);font-size:11px;display:block;text-align:center;}
        
        /* Grid Layouts */
        .legal-terms-section,.bank-totals-section{display:grid;grid-template-columns:1fr 1fr;gap:12px;padding:10px 20px;background-color:var(--bg-highlight);align-items:start}
        
        /* Containers */
        .legal-notice-container,.right-side-container,.terms-container,.notes-container,.totals-container,.bank-info-container{
            display:flex;flex-direction:column;padding:0;margin:0 !important
        }
        
        /* Content Areas */
        .legal-notice,.terms-content,.notes-textarea{
            background-color:var(--bg-light);border:1px solid var(--border);border-radius:4px;
            padding:8px;font-size:13px;color:var(--text-light);line-height:1.4;
            box-shadow:0 1px 3px rgba(0,0,0,0.1);overflow:hidden;resize:none
        }
        .bank-info,.totals-table{
            background-color:white;border:1px solid var(--border);border-radius:4px;
            font-size:14px;color:var(--text-light);line-height:1.3;
            box-shadow:0 1px 3px rgba(0,0,0,0.1);overflow:hidden;resize:none
        }
        
        .terms-content{
            padding:8px 8px 0 8px !important;display:block !important;box-sizing:border-box;
            height:auto;overflow:hidden;
        }
        
        /* Lists */
        .terms-list{padding-left:18px;padding-bottom:0 !important;list-style-type:disc;margin:0 !important;width:100%;font-size:13px !important}
        .terms-list li{margin-bottom:4px !important;padding-bottom:0 !important;line-height:1.4 !important;font-size:13px !important}
        .terms-list li:last-child{margin-bottom:0 !important}
        
        /* Notes */
        #notes-textarea{
            width:100%;margin:0 !important;padding:8px;min-height:50px;height:auto !important;
            line-height:1.5;flex-grow:1;transition:none;-webkit-appearance:none
        }
        
        /* Legal Notice */
        .legal-notice h4{color:var(--primary);margin-bottom:4px;font-size:15px}
        .legal-notice p{margin-bottom:5px}
        
        /* Warranty Table */
        .warranty-term-table{width:100%;border-collapse:collapse;margin:4px 0}
        .warranty-term-table td{padding:3px 5px;border:1px solid var(--border);font-size:12px}
        .warranty-term-table .term-label{width:20%;font-weight:600;background-color:rgba(75,94,122,0.1);color:var(--primary)}
        
        /* Totals Section */
        .totals-table {
            width: 100%;
            border: none;
            background-color: white;
            border-radius: 4px;
        }
        .totals-row {
            height: 28px;
            display: flex;
            align-items: center;
        }
        .totals-row.totals-final {
            margin-top: auto;
            border-top: 1px solid var(--border);
            padding-top: 4px;
            height: 32px;
        }
        .totals-label {
            width: 60%;
            color: var(--text-light);
            font-size: 14px;
            padding-left: 6px;
        }
        .totals-value {
            width: 40%;
            text-align: right;
            font-weight: 600;
            font-size: 14px;
            padding-right: 6px;
        }
        
        /* Select */
        .clean-select{appearance:none;border:none;background:transparent;width:100%;font-size:14px;font-weight:600;color:var(--text-light);cursor:pointer;outline:none;line-height:1.3}
        
        /* Bank Info & Totals Common Styles */
        .bank-info-container, .totals-container {
            height: 210px;
            display: flex;
            flex-direction: column;
        }
        
        .bank-info, .totals-table {
            box-sizing: border-box;
            padding: 8px 10px;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            margin-top: 5px;
        }
        
        /* Bank Info Specific */
        .bank-info .info-group{
            margin: 0;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            height: 100%;
        }
        .bank-info .info-label{
            width: 80px;
            font-weight: 600;
            font-size: 14px;
            display: inline-block;
            color: var(--text-light);
            line-height: 1.3;
        }
        .bank-info .info-group p{
            font-size: 14px;
            line-height: 1.3;
            margin-bottom: 0;
            padding: 3px 0;
            height: 28px;
            display: flex;
            align-items: center;
            overflow: visible;
        }
        .bank-info span[contenteditable="true"]{
            font-size: 14px;
            font-weight: 600;
            line-height: 1.3;
            min-height: 20px;
            display: inline-block;
            overflow: visible;
        }
        
        /* Signature Section */
        .signature-section{width:100%;display:flex;justify-content:space-between;background-color:var(--bg-highlight);padding:10px 20px;gap:12px;align-items:stretch}
        .staff-info,.client-confirmation{width:48%;text-align:left;background-color:white;padding:10px;border:1px solid var(--border);border-radius:4px;display:flex;flex-direction:column;height:100%}
        .staff-info .info-group,.client-confirmation .info-group{margin-top:4px;margin-bottom:0;flex:1;display:flex;flex-direction:column;justify-content:space-between}
        .staff-info .info-label,.client-confirmation .info-label{width:70px}
        
        /* Print Styles */
        @media print {
            *{-webkit-print-color-adjust:exact !important;print-color-adjust:exact !important;color-adjust:exact !important}
            .header{background-color:var(--primary) !important}
            .quote-info,.legal-terms-section,.bank-notes-section,.totals-container,.signature-section{background-color:var(--bg-highlight) !important}
            table th{background-color:var(--secondary) !important}
            .legal-notice,.bank-info{background-color:var(--bg-light) !important}
        }
        
        /* Responsive Styles */
        @media(max-width:768px){
            .container{margin:0;width:100%}
            .header{flex-direction:column;align-items:center;text-align:center;padding:15px}
            .document-title{margin-top:15px;width:100%;text-align:center}
            .quote-info{display:flex;flex-direction:column;padding:10px 15px}
            .client-info,.quote-details,.contact-info{width:100%;margin-bottom:15px}
            .legal-terms-section,.bank-totals-section{display:flex;flex-direction:column;gap:15px;padding:15px}
            .legal-notice-container,.totals-container,.bank-info-container,.right-side-container{width:100%}
            .items-section{padding:10px 15px;overflow-x:auto}
            table{min-width:650px}
            .signature-section{flex-direction:column;padding:15px}
            .staff-info,.client-confirmation{width:100%;margin-bottom:10px}
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header section">
            <div class="company-info">
                <div class="company-logo" id="logo-container"><span class="default-logo-text">玖星吉國際貿易</span></div>
                <input type="file" id="upload-logo" class="upload-logo" accept="image/*">
                <p>統編：89061654</p><p>電話：02-7709-4666</p><p>信箱：service@9starmax.com</p>
            </div>
            <div class="document-title">
                <h2>商品報價單</h2>
                <p>報價單號：<span id="quoteNumber"></span></p>
                <p id="quoteDateContainer">報價日期：<span id="quoteDateText" class="date-display editable-field"></span><input type="date" id="quoteDate" class="hidden-date-input"></p>
                <p id="quoteValidContainer">有效期限：<span id="quoteValidText" class="date-display editable-field"></span><input type="date" id="quoteValidUntil" class="hidden-date-input"></p>
            </div>
        </div>
        <div class="content">
            <div class="quote-info section">
                <div class="client-info">
                    <div class="section-title">客戶資訊</div>
                    <div class="info-group">
                        <h4 contenteditable="true" data-placeholder="請輸入客戶名稱" class="editable-field"></h4>
                        <p contenteditable="true" data-placeholder="請輸入客戶地址" class="editable-field"></p>
                        <p>統一編號：<span contenteditable="true" data-placeholder="請輸入統一編號" class="editable-field"></span></p>
                    </div>
                </div>
                <div class="contact-info">
                    <div class="section-title">聯絡窗口</div>
                    <div class="info-group">
                        <p><span class="info-label">聯絡人：</span> <span contenteditable="true" data-placeholder="請輸入聯絡人資訊" class="editable-field"></span></p>
                        <p><span class="info-label">電話：</span> <span contenteditable="true" data-placeholder="請輸入電話號碼" data-type="phone" class="editable-field"></span></p>
                        <p><span class="info-label">電子郵件：</span> <span contenteditable="true" data-placeholder="請輸入電子郵件" data-type="email" class="editable-field"></span></p>
                    </div>
                </div>
                <div class="quote-details">
                    <div class="section-title">報價資訊</div>
                    <div class="info-group">
                        <p class="quote-meta-row"><span class="info-label">採購編號：</span><span id="poNumber" class="editable-field"></span></p>
                        <p class="quote-meta-row"><span class="info-label">預計交期：</span><span id="deliveryDateText" class="date-display editable-field"></span><input type="date" id="deliveryDate" class="hidden-date-input"></p>
                        <p class="quote-meta-row"><span class="info-label">支付條件：</span><span contenteditable="true" data-placeholder="請輸入支付條件" class="editable-field"></span></p>
                    </div>
                </div>
            </div>
            <div class="items-section section">
                <div class="section-title-with-controls">
                    <div class="section-title">報價商品明細</div>
                    <div class="items-controls">
                        <button class="row-btn add" id="addItemBtn" title="增加一行">+</button>
                        <button class="row-btn delete" id="deleteItemBtn" title="刪除最後一行">-</button>
                    </div>
                </div>
                <div class="table-responsive">
                    <table id="quoteTable">
                        <thead>
                            <tr>
                                <th style="width:15%;">種類</th>
                                <th style="width:30%;">名稱</th>
                                <th style="width:15%;" class="text-center">單價</th>
                                <th style="width:10%;" class="text-center">數量</th>
                                <th style="width:10%;" class="text-center">單位</th>
                                <th style="width:10%;" class="text-center">安裝</th>
                                <th style="width:10%;" class="text-center">運費</th>
                            </tr>
                        </thead>
                        <tbody id="itemsTableBody">
                            <tr>
                                <td><input type="text" class="category-input input-field" placeholder=""></td>
                                <td><input type="text" class="name-input input-field" placeholder=""></td>
                                <td style="text-align:center">
                                    <input type="text" class="price-input input-field" value="">
                                    <span class="original-price"></span>
                                </td>
                                <td class="text-center"><input type="number" class="quantity-input input-field" value="" min="1"></td>
                                <td class="text-center"><input type="text" class="unit-input input-field" value=""></td>
                                <td class="text-center"><input type="text" class="installation-input input-field" value=""></td>
                                <td class="text-center"><input type="text" class="shipping-input input-field" value=""></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- 銀行資訊和總計金額並排 -->
            <div class="bank-totals-section section">
                <div class="bank-info-container">
                    <div class="section-title">銀行資訊</div>
                    <div class="bank-info">
                        <div class="info-group">
                            <p><span class="info-label">金融機構：</span><span contenteditable="true" data-placeholder="請輸入金融機構" class="editable-field">第一銀行</span></p>
                            <p><span class="info-label">機構分支：</span><span contenteditable="true" data-placeholder="請輸入機構分支" class="editable-field">東港分行</span></p>
                            <p><span class="info-label">金融戶名：</span><span contenteditable="true" data-placeholder="請輸入金融戶名" class="editable-field">玖吉發貿易行</span></p>
                            <p><span class="info-label">金融代碼：</span><span contenteditable="true" data-placeholder="請輸入金融代碼" class="editable-field">007</span></p>
                            <p><span class="info-label">金融帳號：</span><span contenteditable="true" data-placeholder="請輸入金融帳號" class="editable-field">7521-0068-870</span></p>
                        </div>
                    </div>
                </div>
                <div class="totals-container">
                    <div class="section-title">總計金額</div>
                    <div class="totals-table">
                        <div class="totals-row"><span class="totals-label">商品合計</span><span class="totals-value" id="subtotal">0</span></div>
                        <div class="totals-row"><span class="totals-label">安裝費用</span><span class="totals-value" id="totalInstallation">0</span></div>
                        <div class="totals-row"><span class="totals-label">運送費用</span><span class="totals-value" id="totalShipping">0</span></div>
                        <div class="totals-row"><span class="totals-label">預付訂金</span><span class="totals-value" id="depositAmount">0</span></div>
                        <div class="totals-row totals-final">
                            <span class="totals-label">
                                <select id="taxType" class="clean-select">
                                    <option value="untaxed" selected>未稅總計金額</option>
                                    <option value="taxed">應稅總計金額</option>
                                </select>
                            </span>
                            <span class="totals-value" id="grandTotal">0</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 法律聲明與合約條款並排，其他備註在合約條款下方 -->
            <div class="legal-terms-section section">
                <div class="legal-notice-container">
                    <div class="section-title">法律聲明與注意事項</div>
                    <div class="legal-notice">
                        <h4>契約法律關係說明</h4>
                        <p>依據中華民國民法第153條及消費者保護法第4條規定，本報價單一經貴方接受並確認，即構成具有法律約束力之買賣契約，雙方均應依誠信原則履行契約義務。</p>
                        <h4>商品瑕疵責任</h4>
                        <p>依據民法第354條及第355條規定，本公司就所出售之商品，擔保其於危險移轉時無滅失或減少其價值之瑕疵，並擔保其具有特定保證之品質。如有瑕疵，買方得依民法第359條主張減少價金或解除契約。</p>
                        <h4>保固與維修責任</h4>
                        <div class="warranty-terms">
                            <table class="warranty-term-table">
                                <tr><td class="term-label">保固範圍</td><td>依商品保固書登載為準未特別約定自交付日起算七日</td></tr>
                                <tr><td class="term-label">保固服務</td><td>保固期內因製造瑕疵損壞，提供免費維修或更換服務</td></tr>
                                <tr><td class="term-label">除外情形</td><td>人為、天災、未經授權拆改或正常耗損導致損壞不保</td></tr>
                                <tr><td class="term-label">特殊約定</td><td>除個別報價單內另有約定之事項條款者，為優先適用</td></tr>
                                <tr><td class="term-label">法定權益</td><td>不影響消費者依《消費者保護法》享有的7天鑑賞期等權利</td></tr>
                            </table>
                        </div>
                        <h4>個人資料保護聲明</h4>
                        <p>依據個人資料保護法規定，本公司蒐集、處理及利用貴方之個人資料，僅限於本交易及售後服務之目的範圍內。貴方享有查詢、閱覽、複製、補充、更正、刪除及停止蒐集處理利用之權利。</p>
                        <h4 style="margin-bottom:4px;">版權免責聲明</h4>
                        <p style="margin-bottom:0;">若貴方提供圖樣、設計或其他內容進行客製化商品製作，貴方需確保擁有該等內容之合法使用權或著作權。對於貴方提供之任何可能涉及第三方著作權、商標權或其他智慧財產權之內容，本公司不負審查義務及侵權責任。若因此導致任何法律爭議或損害，應由貴方承擔全部責任並賠償本公司因此遭受之損失。本公司保留拒絕處理任何疑似侵權內容之權利。</p>
                    </div>
                </div>
                <div class="right-side-container">
                    <div class="terms-container">
                        <div class="section-title">合約條款與條件</div>
                        <div class="terms-content">
                            <ul class="terms-list">
                                <li>本報價單自開立日起30天內有效，逾期未接受者視為自動失效。</li>
                                <li>政府機關、公立學校採購適用政府採購法相關規定，如有牴觸，以政府採購法為準。</li>
                                <li>實際交付之商品顏色、紋理可能因生產批次及自然材質特性而有些微差異，此非屬產品瑕疵。</li>
                                <li>所有金額以新台幣計價，包含基本運送與安裝費用，但不含因現場特殊情況衍生之額外工程費用。</li>
                                <li>驗收時請確實檢查商品外觀及功能，簽收後視為接受商品現況。如有明顯瑕疵，請於驗收時立即提出。</li>
                                <li>報價單確認無誤，需支付總金額30%作為訂金，餘款支付方式若合約另有約定則從其約定，否則應於驗收合格後30日內付清。</li>
                                <li>標準交期為確認訂單後4-6週，實際交期將依訂單確認書為準。遇原物料短缺或不可抗力因素，交期可能順延，本公司將立即通知。</li>
                            </ul>
                        </div>
                    </div>
                    <div class="notes-container">
                        <div class="section-title">其他備註</div>
                        <textarea id="notes-textarea" placeholder="請在此填寫其他特殊需求或說明..." rows="5"></textarea>
                    </div>
                </div>
            </div>
            
            <div class="signature-section section">
                <div class="staff-info" id="staff-info">
                    <div class="section-title" id="staff-title">銷售方資訊</div>
                    <div class="info-group">
                        <p><span class="info-label">姓名：</span> <span contenteditable="true" class="editable-field"></span></p>
                        <p><span class="info-label">電話：</span> <span contenteditable="true" data-type="phone" class="editable-field">02-7709-4666</span></p>
                        <p><span class="info-label">信箱：</span> <span contenteditable="true" data-type="email" class="editable-field">Service@9Starmax.com</span></p>
                    </div>
                </div>
                <div class="client-confirmation" id="client-confirmation">
                    <div class="section-title" id="client-title">採購方資訊</div>
                    <div class="info-group">
                        <p><span class="info-label">姓名：</span> <span contenteditable="true" data-placeholder="請輸入客戶姓名" class="editable-field"></span></p>
                        <p><span class="info-label">電話：</span> <span contenteditable="true" data-placeholder="請輸入電話號碼" data-type="phone" class="editable-field"></span></p>
                        <p><span class="info-label">信箱：</span> <span contenteditable="true" data-placeholder="請輸入電子郵件" data-type="email" class="editable-field"></span></p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // 常量定義
        const MONTH_ABBR = ["JA", "FE", "MR", "AP", "MY", "JN", "JL", "AU", "SE", "OC", "NO", "DE"];
        const TODAY = new Date();
        
        // 快速選擇器
        const $ = id => document.getElementById(id);
        const $all = sel => document.querySelectorAll(sel);
        
        // 元素快取
        const els = {};
        
        // 初始化
        function initApp() {
            // 緩存頻繁使用的DOM元素
            cacheElements();
            
            // 檢查必要元素是否存在
            if (!validateElements()) {
                console.error('初始化失敗：部分必要元素不存在');
                return;
            }
            
            // 初始化各功能模塊
            setupLogoUpload();
            initializeDates();
            setupEditableElements();
            setupEventListeners();
            generateUniqueId(); // 使用更可靠的ID生成方法
            updateTotals();
            
            // 調整容器高度（單次調用並延遲執行）
            setTimeout(adjustLayout, 100);
            
            // 視窗大小變化時重新調整佈局
            window.addEventListener('resize', debounce(adjustLayout, 250));
        }
        
        // 緩存常用DOM元素
        function cacheElements() {
            // 重要元素列表
            const elementIds = [
                'quoteDate', 'quoteDateText', 'quoteValidUntil', 'quoteValidText', 
                'deliveryDate', 'deliveryDateText', 'quoteNumber', 'poNumber', 
                'itemsTableBody', 'taxType', 'subtotal', 'totalShipping', 
                'totalInstallation', 'depositAmount', 'grandTotal', 'notes-textarea', 
                'logo-container', 'upload-logo', 'addItemBtn', 'deleteItemBtn', 'quoteTable'
            ];
            
            // 緩存所有元素
            elementIds.forEach(id => {
                els[id] = $(id);
            });
        }
        
        // 驗證元素是否存在
        function validateElements() {
            const requiredElements = [
                'quoteDate', 'quoteDateText', 'quoteValidUntil', 'quoteValidText', 
                'deliveryDate', 'deliveryDateText', 'quoteNumber', 'poNumber', 
                'itemsTableBody', 'taxType', 'subtotal', 'grandTotal'
            ];
            
            return requiredElements.every(id => els[id] !== null);
        }
        
        // 防抖函數
        function debounce(func, wait) {
            let timeout;
            return function() {
                const context = this;
                const args = arguments;
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(context, args), wait);
            };
        }
        
        // 佈局調整
        function adjustLayout() {
            // 讀取階段 - 收集所有需要的測量數據
            const measurements = collectLayoutMeasurements();
            
            // 寫入階段 - 根據測量數據一次性更新DOM
            applyLayoutMeasurements(measurements);
            
            // 調整文本區域高度
            if (els['notes-textarea']) {
                adjustTextareaHeight();
            }
        }
        
        // 收集佈局測量數據（僅讀取DOM，不寫入）
        function collectLayoutMeasurements() {
            // 由於銀行和總計區域現在使用CSS固定高度，只需收集標題高度
            const bankTotals = {
                bankTitle: document.querySelector('.bank-info-container .section-title')?.offsetHeight || 22,
                totalsTitle: document.querySelector('.totals-container .section-title')?.offsetHeight || 22
            };
            
            // 收集法律和條款區域的數據
            const legalTerms = {
                legalContainer: document.querySelector('.legal-notice-container')?.offsetHeight || 0,
                rightSideContainer: document.querySelector('.right-side-container')?.offsetHeight || 0,
                legalHeader: document.querySelector('.legal-notice-container .section-title')?.offsetHeight || 30,
                termsHeader: document.querySelector('.terms-container .section-title')?.offsetHeight || 30,
                notesContainer: document.querySelector('.notes-container')?.offsetHeight || 0
            };
            
            return { bankTotals, legalTerms };
        }
        
        // 應用佈局測量（一次性寫入DOM）
        function applyLayoutMeasurements(measurements) {
            const { bankTotals, legalTerms } = measurements;
            
            // 銀行和總計區域使用CSS固定高度，不需動態調整
            // 僅同步標題高度確保對齊
            const bankTitle = document.querySelector('.bank-info-container .section-title');
            const totalsTitle = document.querySelector('.totals-container .section-title');
            
            if (bankTitle && totalsTitle) {
                const titleHeight = Math.max(bankTitle.offsetHeight, totalsTitle.offsetHeight);
                bankTitle.style.height = `${titleHeight}px`;
                totalsTitle.style.height = `${titleHeight}px`;
            }
            
            // 調整法律條款區域
            const legalContainer = document.querySelector('.legal-notice-container');
            const rightSideContainer = document.querySelector('.right-side-container');
            const legalNotice = document.querySelector('.legal-notice');
            const termsContent = document.querySelector('.terms-content');
            
            if (legalContainer && rightSideContainer) {
                const maxHeight = Math.max(legalTerms.legalContainer, legalTerms.rightSideContainer);
                legalContainer.style.height = rightSideContainer.style.height = `${maxHeight}px`;
                
                if (legalNotice) {
                    legalNotice.style.height = `${maxHeight - legalTerms.legalHeader - 10}px`;
                }
                
                if (termsContent && legalTerms.notesContainer > 0) {
                    const availableRightHeight = maxHeight - legalTerms.notesContainer - 22;
                    termsContent.style.height = `${availableRightHeight - legalTerms.termsHeader - 10}px`;
                }
            }
        }
        
        // 調整文本區域高度
        function adjustTextareaHeight() {
            const textarea = els['notes-textarea'];
            if (!textarea) return;
            
            textarea.style.height = 'auto';
            textarea.style.height = `${textarea.scrollHeight}px`;
        }
        
        // 初始化日期
        function initializeDates() {
            // 設置報價日期
            if (els.quoteDate && els.quoteDateText) {
                els.quoteDate.value = TODAY.toISOString().split("T")[0];
                els.quoteDateText.textContent = formatDateForDisplay(els.quoteDate.value);
            }
            
            // 設置有效期限
            if (els.quoteValidUntil && els.quoteValidText) {
                const validDate = new Date(TODAY);
                validDate.setDate(TODAY.getDate() + 7);
                els.quoteValidUntil.value = validDate.toISOString().split("T")[0];
                els.quoteValidText.textContent = formatDateForDisplay(els.quoteValidUntil.value);
            }
            
            // 設置交付日期
            if (els.deliveryDate && els.deliveryDateText) {
                const deliveryDate = new Date(TODAY);
                deliveryDate.setDate(TODAY.getDate() + 20);
                els.deliveryDate.value = deliveryDate.toISOString().split("T")[0];
                els.deliveryDateText.textContent = formatDateForDisplay(els.deliveryDate.value);
            }
            
            updateQuoteNumber();
            updatePoNumber();
            setupDateInteractions();
        }
        
        // 生成唯一ID
        function generateUniqueId() {
            if (!els.quoteNumber) return;
            
            // 使用時間戳和隨機數組合生成唯一ID
            const timestamp = new Date().getTime().toString(36);
            const randomStr = Math.random().toString(36).substring(2, 8);
            const uniqueId = `${timestamp}-${randomStr}`.toUpperCase();
            
            // 使用更可讀的格式
            if (els.quoteDate) {
                const date = new Date(els.quoteDate.value || TODAY);
                const month = MONTH_ABBR[date.getMonth()];
                const year = date.getFullYear().toString().slice(-2);
                const monthNum = String(date.getMonth() + 1).padStart(2, "0");
                const day = String(date.getDate()).padStart(2, "0");
                
                // 使用前6個字符作為隨機部分
                const shortRandomStr = uniqueId.substring(0, 6);
                els.quoteNumber.textContent = `${month}-${year}${monthNum}${day}-${shortRandomStr}`;
            }
        }
        
        // 更新報價單號
        function updateQuoteNumber() {
            if (!els.quoteDate || !els.quoteNumber) return;
            
            const date = new Date(els.quoteDate.value || TODAY);
            const monthIndex = date.getMonth();
            const year = date.getFullYear().toString().slice(-2);
            const month = MONTH_ABBR[monthIndex];
            const monthNum = String(monthIndex + 1).padStart(2, "0");
            const day = String(date.getDate()).padStart(2, "0");
            
            // 使用時間戳的一部分替代隨機數
            const timestamp = Date.now().toString().slice(-4);
            els.quoteNumber.textContent = `${month}-${year}${monthNum}${day}-${timestamp}`;
        }
        
        // 更新採購編號
        function updatePoNumber() {
            if (!els.quoteDate || !els.poNumber) return;
            
            const date = new Date(els.quoteDate.value || TODAY);
            const day = String(date.getDate()).padStart(2, "0");
            const month = String(date.getMonth() + 1).padStart(2, "0");
            const year = date.getFullYear().toString().slice(-2);
            
            // 使用時間戳的一部分替代隨機數
            const timestamp = Date.now().toString().slice(-4);
            els.poNumber.textContent = `PO-${timestamp}${day}${month}${year}`;
        }
        
        // 設置日期互動
        function setupDateInteractions() {
            // 設置日期點擊顯示日期選擇器
            [
                {display: els.quoteDateText, picker: els.quoteDate},
                {display: els.quoteValidText, picker: els.quoteValidUntil},
                {display: els.deliveryDateText, picker: els.deliveryDate}
            ].forEach(item => {
                if (item.display && item.picker) {
                    item.display.addEventListener('click', e => {
                        e.preventDefault();
                        if ('showPicker' in item.picker) {
                            item.picker.showPicker();
                        } else {
                            item.picker.focus();
                            item.picker.click();
                        }
                    });
                }
            });
            
            // 日期變更時更新顯示並驗證
            if (els.quoteDate) {
                els.quoteDate.addEventListener('change', function() {
                    if (els.quoteDateText) {
                        els.quoteDateText.textContent = formatDateForDisplay(this.value);
                    }
                    
                    updateQuoteNumber();
                    updatePoNumber();
                    
                    const date = new Date(this.value);
                    
                    // 更新有效期限
                    if (els.quoteValidUntil && els.quoteValidText) {
                        const validDate = new Date(date);
                        validDate.setDate(date.getDate() + 7);
                        els.quoteValidUntil.value = validDate.toISOString().split('T')[0];
                        els.quoteValidText.textContent = formatDateForDisplay(els.quoteValidUntil.value);
                    }
                    
                    // 更新交付日期
                    if (els.deliveryDate && els.deliveryDateText) {
                        const deliveryDate = new Date(date);
                        deliveryDate.setDate(date.getDate() + 20);
                        els.deliveryDate.value = deliveryDate.toISOString().split('T')[0];
                        els.deliveryDateText.textContent = formatDateForDisplay(els.deliveryDate.value);
                    }
                    
                    // 驗證日期
                    validateDates();
                    validateDeliveryDate();
                });
            }
            
            // 有效期限變更
            if (els.quoteValidUntil) {
                els.quoteValidUntil.addEventListener('change', function() {
                    if (els.quoteValidText) {
                        els.quoteValidText.textContent = formatDateForDisplay(this.value);
                    }
                    validateDates();
                });
            }
            
            // 交付日期變更
            if (els.deliveryDate) {
                els.deliveryDate.addEventListener('change', function() {
                    if (els.deliveryDateText) {
                        els.deliveryDateText.textContent = formatDateForDisplay(this.value);
                    }
                    validateDeliveryDate();
                });
            }
        }
        
        // 驗證日期
        function validateDates() {
            if (!els.quoteDate || !els.quoteValidUntil || !els.quoteValidText) return;
            
            const quoteDate = new Date(els.quoteDate.value || TODAY);
            const validDate = new Date(els.quoteValidUntil.value);
            
            if (validDate < quoteDate) {
                const correctedDate = new Date(quoteDate);
                correctedDate.setDate(quoteDate.getDate() + 7);
                els.quoteValidUntil.value = correctedDate.toISOString().split("T")[0];
                els.quoteValidText.textContent = formatDateForDisplay(els.quoteValidUntil.value);
                alert("請注意有效期限不得早於報價日；系統已自動為您修正請再次確認");
            }
            
            const maxValidDate = new Date(quoteDate);
            maxValidDate.setDate(quoteDate.getDate() + 30);
            
            if (validDate > maxValidDate) {
                els.quoteValidUntil.value = maxValidDate.toISOString().split("T")[0];
                els.quoteValidText.textContent = formatDateForDisplay(els.quoteValidUntil.value);
                alert("請注意合約條款第一項有效期限最高為 30 天");
            }
        }
        
        // 驗證交付日期
        function validateDeliveryDate() {
            if (!els.quoteDate || !els.deliveryDate || !els.deliveryDateText) return;
            
            const quoteDate = new Date(els.quoteDate.value || TODAY);
            const deliveryDate = new Date(els.deliveryDate.value);
            
            if (deliveryDate < quoteDate) {
                alert("預計交期不得早於報價日期；請再次確認您設定的預計交期");
                const correctedDate = new Date(quoteDate);
                correctedDate.setDate(quoteDate.getDate() + 20);
                els.deliveryDate.value = correctedDate.toISOString().split("T")[0];
                els.deliveryDateText.textContent = formatDateForDisplay(els.deliveryDate.value);
            }
        }
        
        // Logo上傳
        function setupLogoUpload() {
            if (!els['logo-container'] || !els['upload-logo']) return;
            
            els['logo-container'].addEventListener('click', () => els['upload-logo'].click());
            els['upload-logo'].addEventListener('change', e => {
                const file = e.target.files[0];
                if (!file) return;
                if (!file.type.match('image.*')) {
                    alert('請選擇圖片檔案');
                    return;
                }
                if (file.size > 2*1024*1024) {
                    alert('圖片大小不能超過 2MB');
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = e => {
                    els['logo-container'].innerHTML = '';
                    const img = document.createElement('img');
                    img.src = e.target.result;
                    img.alt = '公司Logo';
                    img.style.maxHeight = '50px';
                    els['logo-container'].appendChild(img);
                };
                reader.readAsDataURL(file);
            });
        }
        
        // 設置可編輯元素
        function setupEditableElements() {
            const editables = $all('[contenteditable="true"],.editable-field');
            if (!editables.length) return;
            
            let isComposing = false;
            
            editables.forEach(el => {
                if (!el) return;
                
                // 處理中文輸入法
                el.addEventListener("compositionstart", () => isComposing = true);
                el.addEventListener("compositionend", function() {
                    isComposing = false;
                    handleInput(this);
                });
                
                // 阻止在可編輯區域按Enter換行
                el.addEventListener("keypress", e => {
                    if (e.key === "Enter") e.preventDefault();
                });
                
                // 輸入處理
                el.addEventListener("input", function() {
                    if (!isComposing) handleInput(this);
                });
                
                // 粘貼處理
                el.addEventListener("paste", function(e) {
                    e.preventDefault();
                    const text = (e.clipboardData || window.clipboardData)
                        .getData("text")
                        .replace(/\n/g, "")
                        .trim();
                    document.execCommand("insertText", false, formatText(text, this.getAttribute("data-type")));
                    setCursorToEnd(this);
                });
            });
        }
        
        // 處理輸入
        function handleInput(element) {
            if (!element) return;
            
            try {
                const cursorPos = saveCursorPosition(element);
                const text = formatText(
                    element.innerText.replace(/\n/g, "").trim(),
                    element.getAttribute("data-type")
                );
                
                const selection = window.getSelection();
                if (!selection) return;
                
                const range = document.createRange();
                range.selectNodeContents(element);
                selection.removeAllRanges();
                selection.addRange(range);
                document.execCommand("insertText", false, text);
                
                if (cursorPos) {
                    restoreCursorPosition(element, cursorPos);
                }
            } catch (err) {
                console.error('處理輸入時發生錯誤:', err);
            }
        }
        
        // 格式化文本
        function formatText(text, type) {
            if (!text) return '';
            
            if (type === "phone") return text.replace(/[^0-9\s()+\-]/g, "");
            if (type === "email") return text.replace(/\s/g, "");
            return text;
        }
        
        // 保存光標位置（安全版本）
        function saveCursorPosition(element) {
            if (!element) return null;
            
            const selection = window.getSelection();
            if (!selection || selection.rangeCount === 0) return null;
            
            const range = selection.getRangeAt(0);
            if (!range || !element.contains(range.startContainer)) return null;
            
            return {
                start: range.startOffset,
                end: range.endOffset,
                container: range.startContainer
            };
        }
        
        // 恢復光標位置（安全版本）
        function restoreCursorPosition(element, position) {
            if (!element || !position) return;
            
            try {
                const selection = window.getSelection();
                if (!selection) return;
                
                const range = document.createRange();
                let targetNode = position.container;
                
                if (targetNode.nodeType !== Node.TEXT_NODE) {
                    const textNodes = Array.from(element.childNodes).filter(n => n.nodeType === Node.TEXT_NODE);
                    targetNode = textNodes[0] || document.createTextNode("");
                    if (!targetNode.parentNode) element.appendChild(targetNode);
                }
                
                const textLength = targetNode.textContent ? targetNode.textContent.length : 0;
                const startPos = Math.min(position.start, textLength);
                const endPos = Math.min(position.end, textLength);
                
                range.setStart(targetNode, startPos);
                range.setEnd(targetNode, endPos);
                selection.removeAllRanges();
                selection.addRange(range);
            } catch (err) {
                console.error('恢復光標位置時發生錯誤:', err);
            }
        }
        
        // 設置光標到末尾
        function setCursorToEnd(element) {
            if (!element) return;
            
            try {
                const selection = window.getSelection();
                if (!selection) return;
                
                const range = document.createRange();
                const textNodes = Array.from(element.childNodes).filter(n => n.nodeType === Node.TEXT_NODE);
                const lastTextNode = textNodes.length ? textNodes[textNodes.length - 1] : document.createTextNode("");
                
                if (!lastTextNode.parentNode) element.appendChild(lastTextNode);
                
                const textLength = lastTextNode.textContent ? lastTextNode.textContent.length : 0;
                range.setStart(lastTextNode, textLength);
                range.setEnd(lastTextNode, textLength);
                selection.removeAllRanges();
                selection.addRange(range);
            } catch (err) {
                console.error('設置光標到末尾時發生錯誤:', err);
            }
        }
        
        // 設置事件監聽
        function setupEventListeners() {
            if (!els.addItemBtn || !els.deleteItemBtn || !els.quoteTable || !els.taxType) return;
            
            // 添加行
            els.addItemBtn.addEventListener('click', () => {
                addRow();
                setTimeout(adjustLayout, 100);
            });
            
            // 刪除行
            els.deleteItemBtn.addEventListener('click', () => {
                if (!els.itemsTableBody) return;
                
                const rows = els.itemsTableBody.children;
                if (rows.length > 1) {
                    rows[rows.length-1].remove();
                    updateTotals();
                    setTimeout(adjustLayout, 100);
                } else {
                    alert("必須保留至少一行！");
                }
            });
            
            // 表格輸入變更
            els.quoteTable.addEventListener('input', debounce(e => {
                if (e.target.classList.contains('input-field')) {
                    updateTotals();
                    setTimeout(adjustLayout, 100);
                }
            }, 100));
            
            // 稅型變更
            els.taxType.addEventListener('change', () => {
                updateTotals();
                setTimeout(adjustLayout, 100);
            });
        }
        
        // 格式化日期顯示
        function formatDateForDisplay(dateString) {
            if (!dateString) return '';
            
            try {
                return new Date(dateString).toLocaleDateString('zh-TW', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
            } catch (e) {
                console.error('日期格式化錯誤:', e);
                return dateString;
            }
        }
        
        // 添加行
        function addRow() {
            if (!els.itemsTableBody) return;
            
            const newRow = document.createElement("tr");
            newRow.innerHTML = `
                <td><input type="text" class="category-input input-field" placeholder=""></td>
                <td><input type="text" class="name-input input-field" placeholder=""></td>
                <td style="text-align:center">
                    <input type="text" class="price-input input-field" value="">
                    <span class="original-price"></span>
                </td>
                <td class="text-center"><input type="number" class="quantity-input input-field" value="" min="1"></td>
                <td class="text-center"><input type="text" class="unit-input input-field" value=""></td>
                <td class="text-center"><input type="text" class="installation-input input-field" value=""></td>
                <td class="text-center"><input type="text" class="shipping-input input-field" value=""></td>
            `;
            els.itemsTableBody.appendChild(newRow);
            updateTotals();
        }
        
        // 更新總計
        function updateTotals() {
            if (!els.itemsTableBody) return;
            
            let subtotal = 0, totalShipping = 0, totalInstallation = 0;
            
            Array.from(els.itemsTableBody.children).forEach(row => {
                const priceInput = row.querySelector(".price-input");
                const quantityInput = row.querySelector(".quantity-input");
                const shippingInput = row.querySelector(".shipping-input");
                const installationInput = row.querySelector(".installation-input");
                
                // 改進的數字解析邏輯
                const price = parseNumericValue(priceInput?.value);
                const quantity = parseNumericValue(quantityInput?.value, true);
                const shipping = parseNumericValue(shippingInput?.value);
                const installation = parseNumericValue(installationInput?.value);
                
                subtotal += price * quantity;
                totalShipping += shipping;
                totalInstallation += installation;
            });
            
            // 計算總計和稅金
            const untaxedTotal = subtotal + totalShipping + totalInstallation;
            const isTaxed = els.taxType && els.taxType.value === "taxed";
            let tax = 0;
            
            if (isTaxed) {
                tax = Math.round(untaxedTotal * 0.05); // 四捨五入稅額
            }
            
            const grandTotal = untaxedTotal + tax;
            const depositAmount = Math.round(grandTotal * 0.3); // 四捨五入訂金金額
            
            // 更新顯示
            if (els.subtotal) els.subtotal.textContent = formatCurrency(subtotal);
            if (els.totalShipping) els.totalShipping.textContent = formatCurrency(totalShipping);
            if (els.totalInstallation) els.totalInstallation.textContent = formatCurrency(totalInstallation);
            if (els.depositAmount) els.depositAmount.textContent = formatCurrency(depositAmount);
            if (els.grandTotal) els.grandTotal.textContent = formatCurrency(grandTotal);
        }
        
        // 解析數值
        function parseNumericValue(value, isInteger = false) {
            if (!value) return 0;
            
            // 移除所有非數字字符，但保留數字和小數點
            const cleanValue = value.toString().replace(/[^\d.-]/g, '');
            
            // 確保負號只出現在開頭
            let sanitizedValue = cleanValue;
            if (cleanValue.indexOf('-') !== -1 && cleanValue.indexOf('-') !== 0) {
                sanitizedValue = cleanValue.replace(/-/g, '');
                if (cleanValue.charAt(0) === '-') {
                    sanitizedValue = '-' + sanitizedValue;
                }
            }
            
            // 解析為數字
            const num = isInteger ? parseInt(sanitizedValue, 10) : parseFloat(sanitizedValue);
            return isNaN(num) ? 0 : num;
        }
        
        // 格式化貨幣
        function formatCurrency(value) {
            if (isNaN(value)) return '0';
            
            // 使用千分位格式化
            return value.toLocaleString('zh-TW', {
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            });
        }
        
        // 啟動應用程序
        initApp();
    });
    </script>
</body>
</html>
