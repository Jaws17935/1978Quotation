<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>百貨銷售報價單</title>
    <style>
        :root {--primary:#1e3a8a;--secondary:#4b5e7a;--accent:#3b82f6;--bg-light:#f8fafc;--bg-highlight:#f1f5f9;--text:#111827;--text-light:#6b7280;--border:#e5e7eb;--success:#15803d;--danger:#e53e3e}
        *{margin:0;padding:0;box-sizing:border-box;font-family:Arial,sans-serif}
        body{background-color:var(--bg-light);color:var(--text);line-height:1.5;font-size:14px}
        ::-webkit-scrollbar{width:0;height:0;background:transparent}
        *{-ms-overflow-style:none;scrollbar-width:none}
        .container{max-width:1000px;margin:0 auto 20px;background-color:white;box-shadow:0 0 20px rgba(0,0,0,0.1)}
        .section{border-bottom:1px solid var(--border);margin-bottom:10px;padding-bottom:10px}
        .header{background-color:var(--primary);color:white;padding:10px 20px;display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:0;padding-bottom:0;border-bottom:none}
        .company-logo{position:relative;cursor:pointer}
        .company-logo:hover{opacity:0.9}
        
        .company-logo img{max-height:50px;object-fit:contain}
        .upload-logo{position:absolute;width:0.1px;height:0.1px;opacity:0;z-index:-1}
        .company-info p{opacity:0.9;margin-bottom:2px;line-height:1.3}
        .default-logo-text{font-size:22px;font-weight:600;color:white}
        .document-title h2{font-size:20px;font-weight:600;margin-bottom:2px;margin-left:-20px}
        .document-title p{color:rgba(255,255,255,0.9);margin-bottom:2px;line-height:1.3}
        .date-display{cursor:pointer;transition:opacity 0.2s;border-bottom:1px dashed rgba(0,0,0,0.3);padding-bottom:1px;background-color:transparent}
        .date-display:hover{opacity:0.8;border-bottom:1px dashed rgba(0,0,0,0.6)}
        .document-title .date-display,.document-title .editable-field{color:white;border-bottom:1px dashed rgba(255,255,255,0.5)}
        .document-title .date-display:hover{border-bottom:1px dashed rgba(255,255,255,0.8)}
        .hidden-date-input{position:absolute;opacity:0;width:1px;height:1px;overflow:hidden}
        .content .date-display{color:var(--text);border-bottom:1px dashed var(--accent);display:inline-block;min-width:120px}
        .quote-info{padding:8px 20px;display:grid;grid-template-columns:repeat(3,1fr);gap:15px;background-color:var(--bg-highlight)}
        #poNumber{display:inline-block;min-width:100px}
        .section-title,.section-title-with-controls{position:relative;padding-bottom:2px;height:20px;margin-bottom:2px;box-sizing:border-box}
        .section-title{font-size:14px;text-transform:uppercase;letter-spacing:1px;color:var(--primary);font-weight:600;display:flex;align-items:center}
        .section-title:after{content:'';position:absolute;left:0;bottom:0;width:36px;height:2px;background-color:var(--accent)}
        .info-group{margin-bottom:6px;overflow:hidden}
        .info-group h4{font-size:14px;margin-bottom:3px;color:var(--text);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
        .info-group p{color:var(--text-light);margin-bottom:4px;line-height:1.4;word-wrap:break-word}
        .info-label{font-weight:600;display:inline-block;width:90px}
        .quote-meta-row{margin-bottom:2px;line-height:1.2}
        [contenteditable=true],.editable-field{border-bottom:none;padding:1px;min-height:18px;min-width:80px;display:inline-block;color:var(--text);background-color:transparent}
        [contenteditable=true]:hover,.editable-field:hover{background-color:rgba(59,130,246,0.1)}
        [contenteditable=true]:focus,.editable-field:focus{outline:none;border-bottom:1px dashed var(--accent);background-color:rgba(59,130,246,0.1)}
        .items-section{padding:10px 20px;background-color:white}
        .section-title-with-controls{display:flex;align-items:center;justify-content:space-between}
        .items-controls{display:flex;align-items:center;gap:5px;margin-left:10px}
        .row-btn{background:none;border:none;cursor:pointer;font-size:18px;font-weight:bold;width:24px;height:24px;text-align:center;line-height:20px;transition:transform 0.2s;padding:0}
        .row-btn.add{color:var(--success)}
        .row-btn.delete{color:var(--danger)}
        .row-btn:hover{transform:scale(1.2)}
        table{width:100%;border-collapse:collapse;margin-top:6px;border:1px solid var(--border)}
        table th{background-color:var(--secondary);color:white;text-align:left;padding:5px;font-weight:600;border-bottom:2px solid var(--primary)}
        table td{padding:3px 5px;border-bottom:1px solid var(--border);vertical-align:middle}
        table tbody tr:hover{background-color:var(--bg-light)}
        .text-center{text-align:center}
        .input-field{width:100%;padding:2px;border:none;border-radius:2px;font-size:14px}
        .price-input{text-align:center}
        .quantity-input,.shipping-input,.installation-input,.unit-input{text-align:center}
        .input-field:focus{outline:none;border-color:var(--accent)}
        .quantity-input::-webkit-inner-spin-button,.quantity-input::-webkit-outer-spin-button{-webkit-appearance:none;margin:0}
        .quantity-input{-moz-appearance:textfield;appearance:none}
        .original-price{text-decoration:line-through;color:var(--text-light);font-size:11px;display:block;text-align:center}
        .legal-terms-section, .bank-totals-section{display:grid;grid-template-columns:1fr 1fr;gap:8px;padding:8px 20px;background-color:var(--bg-highlight);align-items:start}
        .flex-column-container{display:flex;flex-direction:column;padding:0;margin:0}
        .content-box-light{background-color:var(--bg-light);border:1px solid var(--border);border-radius:4px;padding:8px;font-size:13px;color:var(--text-light);line-height:1.4;box-shadow:0 1px 3px rgba(0,0,0,0.1);overflow:hidden;resize:none}
        .content-box-white{background-color:white;border:1px solid var(--border);border-radius:4px;font-size:14px;color:var(--text-light);line-height:1.3;box-shadow:0 1px 3px rgba(0,0,0,0.1);overflow:hidden;resize:none}
        .terms-content{padding:8px 8px 0 8px;display:block;box-sizing:border-box;height:auto;overflow:hidden}
        .terms-list{padding-left:18px;padding-bottom:0;list-style-type:disc;margin:0;width:100%;font-size:13px}
        .terms-list li{margin-bottom:4px;padding-bottom:0;line-height:1.4;font-size:13px}
        .terms-list li:last-child{margin-bottom:0}
        #notes-textarea{width:100%;margin:0;padding:8px;min-height:80px;height:auto;line-height:1.5;flex-grow:1;transition:none;-webkit-appearance:none;resize:vertical;max-height:none;box-sizing:border-box;border:1px solid var(--border);background-color:var(--bg-light);font-size:13px;color:var(--text-light)}
        .notes-container{position:relative;width:100%;min-height:100px;margin-top:5px;padding:0;overflow:hidden}
        .legal-notice h4{color:var(--primary);margin-bottom:4px;font-size:15px}
        .legal-notice p{margin-bottom:5px}
        .warranty-term-table{width:100%;border-collapse:collapse;margin:4px 0}
        .warranty-term-table td{padding:3px 5px;border:1px solid var(--border);font-size:12px}
        .warranty-term-table .term-label{width:20%;font-weight:600;background-color:rgba(75,94,122,0.1);color:var(--primary)}
        .totals-table{width:100%;border:none;background-color:white;border-radius:4px}
        .totals-row{height:24px;display:flex;align-items:center}
        .totals-row.totals-final{margin-top:auto;border-top:1px solid var(--border);padding-top:3px;height:28px}
        .totals-label{width:60%;color:var(--text-light);font-size:13px;padding-left:5px}
        .totals-value{width:40%;text-align:right;font-weight:600;font-size:13px;padding-right:5px}
        .clean-select{appearance:none;border:none;background:transparent;width:100%;font-size:13px;font-weight:600;color:var(--text-light);cursor:pointer;outline:none;line-height:1.2}
        .bank-info-container, .totals-container{height:180px;display:flex;flex-direction:column}
        .bank-info, .totals-table{box-sizing:border-box;padding:6px 8px;flex-grow:1;display:flex;flex-direction:column;margin-top:3px}
        .bank-info .info-group{margin:0;display:flex;flex-direction:column;justify-content:space-between;height:100%}
        .bank-info .info-label{width:75px;font-weight:600;font-size:13px;display:inline-block;color:var(--text-light);line-height:1.2}
        .bank-info .info-group p{font-size:13px;line-height:1.2;margin-bottom:0;padding:2px 0;height:24px;display:flex;align-items:center;overflow:hidden}
        .bank-info span[contenteditable="true"]{font-size:13px;font-weight:600;line-height:1.2;min-height:18px;display:inline-block;overflow:hidden}
        .signature-section{width:100%;display:flex;justify-content:space-between;background-color:var(--bg-highlight);padding:10px 20px;gap:12px;align-items:stretch}
        .staff-info,.client-confirmation{width:48%;text-align:left;background-color:white;padding:10px;border:1px solid var(--border);border-radius:4px;display:flex;flex-direction:column;height:100%}
        .staff-info .info-group,.client-confirmation .info-group{margin-top:4px;margin-bottom:0;flex:1;display:flex;flex-direction:column;justify-content:space-between}
        .staff-info .info-label,.client-confirmation .info-label{width:70px}
        .notification-container{position:fixed;top:20px;right:20px;max-width:350px;background:white;box-shadow:0 4px 12px rgba(0,0,0,0.15);border-radius:4px;overflow:hidden;z-index:9999;transition:all 0.3s ease;opacity:0;transform:translateY(-20px)}
        .notification-container.show{opacity:1;transform:translateY(0)}
        .notification-content{padding:12px 16px;display:flex;align-items:center;justify-content:space-between}
        .notification-message{flex:1;margin-right:10px;font-size:14px}
        .notification-close{background:none;border:none;font-size:18px;cursor:pointer;padding:0 4px;line-height:1}
        .notification-info{border-left:4px solid var(--accent)}
        .notification-success{border-left:4px solid var(--success)}
        .notification-warning{border-left:4px solid #f59e0b}
        .notification-error{border-left:4px solid var(--danger)}
        .info-group-text{margin-bottom:4px;line-height:1.4;word-wrap:break-word;color:var(--text-light)}
        @media(max-width:768px){
            .container{margin:0;width:100%}
            .header{flex-direction:column;align-items:center;text-align:center;padding:15px}
            .document-title{margin-top:15px;width:100%;text-align:center}
            .quote-info{display:flex;flex-direction:column;padding:10px 15px}
            .client-info,.quote-details,.contact-info{width:100%;margin-bottom:15px}
            .legal-terms-section,.bank-totals-section{display:flex;flex-direction:column;gap:15px;padding:15px}
            .legal-notice-container,.totals-container,.bank-info-container,.right-side-container{width:100%}
            .items-section{padding:10px 15px;overflow-x:hidden}
            table{min-width:650px}
            .signature-section{flex-direction:column;padding:15px}
            .staff-info,.client-confirmation{width:100%;margin-bottom:10px}
        }
        @media (min-width:769px) and (max-width:992px){
            .container{margin:0 auto;width:95%}
            .legal-terms-section, .bank-totals-section{gap:12px}
            .section-title{font-size:13px}
        }
        @media print{
            *{-webkit-print-color-adjust:exact;print-color-adjust:exact;color-adjust:exact}
            body{width:100%;margin:0;padding:0}
            .container{width:100%;margin:0;box-shadow:none}
            .header{background-color:var(--primary) !important}
            .quote-info,.legal-terms-section,.signature-section{background-color:var(--bg-highlight) !important}
            table th{background-color:var(--secondary) !important}
            .legal-notice,.bank-info{background-color:var(--bg-light) !important}
            .row-btn, .upload-logo, .notification-container{display:none !important}
            .editable-field, [contenteditable=true]{border:none !important;background-color:transparent !important}
            .content-box-light, .content-box-white{box-shadow:none !important;border:1px solid #ccc !important}
            table th{background-color:#4b5e7a !important;-webkit-print-color-adjust:exact !important;color-adjust:exact !important}
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header section">
            <div class="company-info">
                <div class="company-logo" id="logo-container"><span class="default-logo-text">玖星吉國際貿易</span></div>
                <input type="file" id="upload-logo" class="upload-logo" accept="image/*">
                <p>統編：89061654</p><p>電話：02-7709-4666</p><p>信箱：service@9starmax.com</p>
            </div>
            <div class="document-title">
                <h2>商品報價單</h2>
                <p>報價單號：<span id="quoteNumber"></span></p>
                <p id="quoteDateContainer">報價日期：<span id="quoteDateText" class="date-display editable-field"></span><input type="date" id="quoteDate" class="hidden-date-input"></p>
                <p id="quoteValidContainer">有效期限：<span id="quoteValidText" class="date-display editable-field"></span><input type="date" id="quoteValidUntil" class="hidden-date-input"></p>
            </div>
        </div>
        <div class="content">
            <div class="quote-info section">
                <div class="client-info">
                    <div class="section-title">客戶資訊</div>
                    <div class="info-group">
                        <h4 contenteditable="true" data-placeholder="請輸入客戶名稱" class="editable-field"></h4>
                        <p contenteditable="true" data-placeholder="請輸入客戶地址" class="editable-field"></p>
                        <p>統一編號：<span contenteditable="true" data-placeholder="請輸入統一編號" class="editable-field"></span></p>
                    </div>
                </div>
                <div class="contact-info">
                    <div class="section-title">聯絡窗口</div>
                    <div class="info-group">
                        <p><span class="info-label">聯絡人：</span> <span contenteditable="true" data-placeholder="請輸入聯絡人資訊" class="editable-field"></span></p>
                        <p><span class="info-label">電話：</span> <span contenteditable="true" data-placeholder="請輸入電話號碼" data-type="phone" class="editable-field"></span></p>
                        <p><span class="info-label">電子郵件：</span> <span contenteditable="true" data-placeholder="請輸入電子郵件" data-type="email" class="editable-field"></span></p>
                    </div>
                </div>
                <div class="quote-details">
                    <div class="section-title">報價資訊</div>
                    <div class="info-group">
                        <p class="quote-meta-row"><span class="info-label">採購編號：</span><span id="poNumber" class="editable-field"></span></p>
                        <p class="quote-meta-row"><span class="info-label">預計交期：</span><span id="deliveryDateText" class="date-display editable-field"></span><input type="date" id="deliveryDate" class="hidden-date-input"></p>
                        <p class="quote-meta-row"><span class="info-label">支付條件：</span><span contenteditable="true" data-placeholder="請輸入支付條件" class="editable-field"></span></p>
                    </div>
                </div>
            </div>
            <div class="items-section section">
                <div class="section-title-with-controls">
                    <div class="section-title">報價商品明細</div>
                    <div class="items-controls">
                        <button class="row-btn add" id="addItemBtn" title="增加一行">+</button>
                        <button class="row-btn delete" id="deleteItemBtn" title="刪除最後一行">-</button>
                    </div>
                </div>
                <div class="table-responsive">
                    <table id="quoteTable">
                        <thead>
                            <tr>
                                <th style="width:15%;">種類</th>
                                <th style="width:30%;">名稱</th>
                                <th style="width:15%;" class="text-center">單價</th>
                                <th style="width:10%;" class="text-center">數量</th>
                                <th style="width:10%;" class="text-center">單位</th>
                                <th style="width:10%;" class="text-center">安裝</th>
                                <th style="width:10%;" class="text-center">運費</th>
                            </tr>
                        </thead>
                        <tbody id="itemsTableBody">
                            <tr>
                                <td><input type="text" class="category-input input-field" placeholder=""></td>
                                <td><input type="text" class="name-input input-field" placeholder=""></td>
                                <td style="text-align:center">
                                    <input type="text" class="price-input input-field" value="">
                                    <span class="original-price"></span>
                                </td>
                                <td class="text-center"><input type="number" class="quantity-input input-field" value="" min="1"></td>
                                <td class="text-center"><input type="text" class="unit-input input-field" value=""></td>
                                <td class="text-center"><input type="text" class="installation-input input-field" value=""></td>
                                <td class="text-center"><input type="text" class="shipping-input input-field" value=""></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            
            <div class="bank-totals-section section">
                <div class="bank-info-container flex-column-container">
                    <div class="section-title">銀行資訊</div>
                    <div class="bank-info content-box-white">
                        <div class="info-group">
                            <p><span class="info-label">金融機構：</span><span contenteditable="true" data-placeholder="請輸入金融機構" class="editable-field">第一銀行</span></p>
                            <p><span class="info-label">機構分支：</span><span contenteditable="true" data-placeholder="請輸入機構分支" class="editable-field">東港分行</span></p>
                            <p><span class="info-label">金融戶名：</span><span contenteditable="true" data-placeholder="請輸入金融戶名" class="editable-field">玖吉發貿易行</span></p>
                            <p><span class="info-label">金融代碼：</span><span contenteditable="true" data-placeholder="請輸入金融代碼" class="editable-field">007</span></p>
                            <p><span class="info-label">金融帳號：</span><span contenteditable="true" data-placeholder="請輸入金融帳號" class="editable-field">7521-0068-870</span></p>
                        </div>
                    </div>
                </div>
                <div class="totals-container flex-column-container">
                    <div class="section-title">總計金額</div>
                    <div class="totals-table content-box-white">
                        <div class="totals-row"><span class="totals-label">商品合計</span><span class="totals-value" id="subtotal">0</span></div>
                        <div class="totals-row"><span class="totals-label">安裝費用</span><span class="totals-value" id="totalInstallation">0</span></div>
                        <div class="totals-row"><span class="totals-label">運送費用</span><span class="totals-value" id="totalShipping">0</span></div>
                        <div class="totals-row"><span class="totals-label">預付訂金</span><span class="totals-value" id="depositAmount">0</span></div>
                        <div class="totals-row totals-final">
                            <span class="totals-label">
                                <select id="taxType" class="clean-select">
                                    <option value="untaxed" selected>未稅總計金額</option>
                                    <option value="taxed">應稅總計金額</option>
                                </select>
                            </span>
                            <span class="totals-value" id="grandTotal">0</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="legal-terms-section section">
                <div class="legal-notice-container flex-column-container">
                    <div class="section-title">法律聲明與注意事項</div>
                    <div class="legal-notice content-box-light">
                        <h4>契約法律關係說明</h4>
                        <p>依據中華民國民法第153條及消費者保護法第4條規定，本報價單一經貴方接受並確認，即構成具有法律約束力之買賣契約，雙方均應依誠信原則履行契約義務。</p>
                        <h4>商品瑕疵責任</h4>
                        <p>依據民法第354條及第355條規定，本公司就所出售之商品，擔保其於危險移轉時無滅失或減少其價值之瑕疵，並擔保其具有特定保證之品質。如有瑕疵，買方得依民法第359條主張減少價金或解除契約。</p>
                        <h4>保固與維修責任</h4>
                        <div class="warranty-terms">
                            <table class="warranty-term-table">
                                <tr><td class="term-label">保固範圍</td><td>依商品保固書登載為準未特別約定自交付日起算七日</td></tr>
                                <tr><td class="term-label">保固服務</td><td>保固期內因製造瑕疵損壞，提供免費維修或更換服務</td></tr>
                                <tr><td class="term-label">除外情形</td><td>人為、天災、未經授權拆改或正常耗損導致損壞不保</td></tr>
                                <tr><td class="term-label">特殊約定</td><td>除個別報價單內另有約定之事項條款者，為優先適用</td></tr>
                                <tr><td class="term-label">法定權益</td><td>不影響消費者依《消費者保護法》享有的7天鑑賞期等權利</td></tr>
                            </table>
                        </div>
                        <h4>個人資料保護聲明</h4>
                        <p>依據個人資料保護法規定，本公司蒐集、處理及利用貴方之個人資料，僅限於本交易及售後服務之目的範圍內。貴方享有查詢、閱覽、複製、補充、更正、刪除及停止蒐集處理利用之權利。</p>
                        <h4 style="margin-bottom:4px;">版權免責聲明</h4>
                        <p style="margin-bottom:0;">若貴方提供圖樣、設計或其他內容進行客製化商品製作，貴方需確保擁有該等內容之合法使用權或著作權。對於貴方提供之任何可能涉及第三方著作權、商標權或其他智慧財產權之內容，本公司不負審查義務及侵權責任。若因此導致任何法律爭議或損害，應由貴方承擔全部責任並賠償本公司因此遭受之損失。本公司保留拒絕處理任何疑似侵權內容之權利。</p>
                    </div>
                </div>
                <div class="right-side-container flex-column-container">
                    <div class="terms-container">
                        <div class="section-title">合約條款與條件</div>
                        <div class="terms-content content-box-light">
                            <ul class="terms-list">
                                <li>本報價單自開立日起30天內有效，逾期未接受者視為自動失效。</li>
                                <li>政府機關、公立學校採購適用政府採購法相關規定，如有牴觸，以政府採購法為準。</li>
                                <li>實際交付之商品顏色、紋理可能因生產批次及自然材質特性而有些微差異，此非屬產品瑕疵。</li>
                                <li>所有金額以新台幣計價，包含基本運送與安裝費用，但不含因現場特殊情況衍生之額外工程費用。</li>
                                <li>驗收時請確實檢查商品外觀及功能，簽收後視為接受商品現況。如有明顯瑕疵，請於驗收時立即提出。</li>
                                <li>報價單確認無誤，需支付總金額30%作為訂金，餘款支付方式若合約另有約定則從其約定，否則應於驗收合格後30日內付清。</li>
                                <li>標準交期為確認訂單後4-6週，實際交期將依訂單確認書為準。遇原物料短缺或不可抗力因素，交期可能順延，本公司將立即通知。</li>
                            </ul>
                        </div>
                    </div>
                    <div class="notes-container">
                        <div class="section-title">其他備註</div>
                        <textarea id="notes-textarea" class="content-box-light" placeholder="請在此填寫其他特殊需求或說明..." rows="5"></textarea>
                    </div>
                </div>
            </div>
            
            <div class="signature-section section">
                <div class="staff-info" id="staff-info">
                    <div class="section-title" id="staff-title">銷售方資訊</div>
                    <div class="info-group">
                        <p><span class="info-label">姓名：</span> <span contenteditable="true" class="editable-field"></span></p>
                        <p><span class="info-label">電話：</span> <span contenteditable="true" data-type="phone" class="editable-field">02-7709-4666</span></p>
                        <p><span class="info-label">信箱：</span> <span contenteditable="true" data-type="email" class="editable-field">Service@9Starmax.com</span></p>
                    </div>
                </div>
                <div class="client-confirmation" id="client-confirmation">
                    <div class="section-title" id="client-title">採購方資訊</div>
                    <div class="info-group">
                        <p><span class="info-label">姓名：</span> <span contenteditable="true" data-placeholder="請輸入客戶姓名" class="editable-field"></span></p>
                        <p><span class="info-label">電話：</span> <span contenteditable="true" data-placeholder="請輸入電話號碼" data-type="phone" class="editable-field"></span></p>
                        <p><span class="info-label">信箱：</span> <span contenteditable="true" data-placeholder="請輸入電子郵件" data-type="email" class="editable-field"></span></p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // 常量配置
        const CONFIG = {
            TAX_RATE: 0.05,
            DEPOSIT_RATE: 0.3,
            DEFAULT_VALID_DAYS: 7,
            MAX_VALID_DAYS: 30,
            DEFAULT_DELIVERY_DAYS: 20
        };
        
        const MONTH_ABBR = ["JA", "FE", "MR", "AP", "MY", "JN", "JL", "AU", "SE", "OC", "NO", "DE"];
        const TODAY = new Date();
        
        // DOM 元素簡易選擇器
        const $ = id => document.getElementById(id);
        const $all = sel => document.querySelectorAll(sel);
        
        // 初始化
        function init() {
            // 驗證關鍵元素
            const requiredEls = ['quoteNumber', 'quoteDateText', 'quoteValidText', 'deliveryDateText',
                               'itemsTableBody', 'subtotal', 'grandTotal', 'taxType'];
            if(!requiredEls.every(id => $(id))) {
                console.error('初始化失敗：部分必要元素不存在');
                return;
            }
            
            setupLogoUpload();
            initDates();
            setupEditableElements();
            setupEventListeners();
            updateTotals();
            setTimeout(adjustLayout, 100);
            window.addEventListener('resize', debounce(adjustLayout, 250));
        }
        
        // 防抖函數
        const debounce = (fn, wait) => {
            let t;
            return function() {
                clearTimeout(t);
                t = setTimeout(() => fn.apply(this, arguments), wait);
            };
        }
        
        // 調整布局
        function adjustLayout() {
            const bankTitle = document.querySelector('.bank-info-container .section-title');
            const totalsTitle = document.querySelector('.totals-container .section-title');
            
            if (bankTitle && totalsTitle) {
                const h = Math.max(bankTitle.offsetHeight, totalsTitle.offsetHeight);
                bankTitle.style.height = totalsTitle.style.height = `${h}px`;
            }
            
            // 調整文本區域高度
            const textarea = $('notes-textarea');
            if (textarea) {
                textarea.style.height = 'auto';
                textarea.style.height = Math.max(80, textarea.scrollHeight) + 'px';
            }
        }
        
        // 初始化日期
        function initDates() {
            // 設置報價日期
            const quoteDate = $('quoteDate');
            const quoteDateText = $('quoteDateText');
            if (quoteDate && quoteDateText) {
                quoteDate.value = TODAY.toISOString().split("T")[0];
                quoteDateText.textContent = formatDate(quoteDate.value);
            }
            
            // 設置有效期限
            const validDate = $('quoteValidUntil');
            const validText = $('quoteValidText');
            if (validDate && validText) {
                const vDate = new Date(TODAY);
                vDate.setDate(TODAY.getDate() + CONFIG.DEFAULT_VALID_DAYS);
                validDate.value = vDate.toISOString().split("T")[0];
                validText.textContent = formatDate(validDate.value);
            }
            
            // 設置交期日期
            const delivDate = $('deliveryDate');
            const delivText = $('deliveryDateText');
            if (delivDate && delivText) {
                const dDate = new Date(TODAY);
                dDate.setDate(TODAY.getDate() + CONFIG.DEFAULT_DELIVERY_DAYS);
                delivDate.value = dDate.toISOString().split("T")[0];
                delivText.textContent = formatDate(delivDate.value);
            }
            
            updateQuoteNumber();
            updatePoNumber();
            setupDateInteractions();
        }
        
        // 生成唯一ID
        function generateId(date = TODAY, prefix = '', type = 'quote') {
            const month = MONTH_ABBR[date.getMonth()];
            const year = date.getFullYear().toString().slice(-2);
            const monthNum = String(date.getMonth() + 1).padStart(2, "0");
            const day = String(date.getDate()).padStart(2, "0");
            const rand = Math.random().toString(36).substring(2, 4).toUpperCase();
            
            return type === 'po' 
                ? `${prefix}${rand}${monthNum}${day}${year}`
                : `${prefix}${month}-${year}${monthNum}${day}${rand}`;
        }
        
        // 更新報價單號與採購編號
        function updateQuoteNumber() {
            const qNum = $('quoteNumber');
            const qDate = $('quoteDate');
            if (!qNum) return;
            
            const date = new Date((qDate?.value) || TODAY);
            qNum.textContent = generateId(date);
        }
        
        function updatePoNumber() {
            const po = $('poNumber');
            const qDate = $('quoteDate');
            if (po && qDate) {
                const date = new Date(qDate.value || TODAY);
                po.textContent = generateId(date, 'PO-', 'po');
            }
        }
        
        // 設置日期互動
        function setupDateInteractions() {
            [
                {display: $('quoteDateText'), picker: $('quoteDate')},
                {display: $('quoteValidText'), picker: $('quoteValidUntil')},
                {display: $('deliveryDateText'), picker: $('deliveryDate')}
            ].forEach(item => {
                if (item.display && item.picker) {
                    item.display.addEventListener('click', e => {
                        e.preventDefault();
                        if ('showPicker' in item.picker) {
                            item.picker.showPicker();
                        } else {
                            item.picker.focus();
                            item.picker.click();
                        }
                    });
                }
            });
            
            // 報價日期變更
            const qDate = $('quoteDate');
            if (qDate) {
                qDate.addEventListener('change', function() {
                    const qText = $('quoteDateText');
                    if (qText) qText.textContent = formatDate(this.value);
                    
                    updateQuoteNumber();
                    updatePoNumber();
                    validateDates();
                    validateDeliveryDate();
                    showNotification("報價日期已更新", "info");
                });
            }
            
            // 有效期限變更
            const vDate = $('quoteValidUntil');
            if (vDate) {
                vDate.addEventListener('change', function() {
                    const vText = $('quoteValidText');
                    if (vText) vText.textContent = formatDate(this.value);
                    validateDates();
                });
            }
            
            // 交期日期變更
            const dDate = $('deliveryDate');
            if (dDate) {
                dDate.addEventListener('change', function() {
                    const dText = $('deliveryDateText');
                    if (dText) dText.textContent = formatDate(this.value);
                    validateDeliveryDate();
                });
            }
        }
        
        // 日期驗證相關函數
        function validateMinDate(dateInput, dateText, minDate, message) {
            if (!dateInput || !dateText || !minDate) return false;
            
            const selectedDate = new Date(dateInput.value);
            if (selectedDate < minDate) {
                if (confirm(message)) {
                    const correctedDate = new Date(minDate);
                    correctedDate.setDate(minDate.getDate() + 1);
                    dateInput.value = correctedDate.toISOString().split("T")[0];
                    dateText.textContent = formatDate(dateInput.value);
                    return true;
                }
            }
            return false;
        }
        
        function validateMaxDate(dateInput, dateText, maxDate, message) {
            if (!dateInput || !dateText || !maxDate) return false;
            
            const selectedDate = new Date(dateInput.value);
            if (selectedDate > maxDate) {
                if (confirm(message)) {
                    dateInput.value = maxDate.toISOString().split("T")[0];
                    dateText.textContent = formatDate(dateInput.value);
                    return true;
                }
            }
            return false;
        }
        
        // 驗證有效期限
        function validateDates() {
            const qDate = $('quoteDate');
            const vDate = $('quoteValidUntil');
            const vText = $('quoteValidText');
            
            if (!qDate || !vDate || !vText) return;
            
            const quoteDate = new Date(qDate.value || TODAY);
            
            // 檢查最小日期 - 有效期限不應早於報價日期
            validateMinDate(
                vDate, vText, quoteDate, 
                "有效期限不得早於報價日期。是否自動調整為報價日期後 " + CONFIG.DEFAULT_VALID_DAYS + " 天？"
            );
            
            // 檢查最大日期 - 有效期限不應超過最大天數
            const maxValidDate = new Date(quoteDate);
            maxValidDate.setDate(quoteDate.getDate() + CONFIG.MAX_VALID_DAYS);
            validateMaxDate(
                vDate, vText, maxValidDate,
                "根據合約條款，有效期限最長為 " + CONFIG.MAX_VALID_DAYS + " 天。是否調整為最長期限？"
            );
        }
        
        // 驗證交付日期
        function validateDeliveryDate() {
            const qDate = $('quoteDate');
            const dDate = $('deliveryDate');
            const dText = $('deliveryDateText');
            
            if (!qDate || !dDate || !dText) return;
            
            const quoteDate = new Date(qDate.value || TODAY);
            
            validateMinDate(
                dDate, dText, quoteDate,
                "預計交期不得早於報價日期。是否自動調整為報價日期後 " + CONFIG.DEFAULT_DELIVERY_DAYS + " 天？"
            );
        }
        
        // Logo上傳
        function setupLogoUpload() {
            const logoContainer = $('logo-container');
            const uploadLogo = $('upload-logo');
            
            if (!logoContainer || !uploadLogo) return;
            
            // 點擊觸發檔案選擇
            logoContainer.addEventListener('click', () => {
                uploadLogo.value = '';
                uploadLogo.click();
            });
            
            // 檔案選擇處理
            uploadLogo.addEventListener('change', e => {
                const file = e.target.files[0];
                if (!file) return;
                
                if (!file.type.match('image.*')) {
                    showNotification('請選擇圖片檔案', 'error');
                    return;
                }
                
                if (file.size > 2*1024*1024) {
                    showNotification('圖片大小不能超過 2MB', 'error');
                    return;
                }
                
                const reader = new FileReader();
                
                reader.onerror = () => {
                    showNotification('讀取圖片時發生錯誤', 'error');
                };
                
                reader.onload = e => {
                    try {
                        const tempImg = new Image();
                        tempImg.onload = () => {
                            logoContainer.innerHTML = '';
                            const img = document.createElement('img');
                            img.src = e.target.result;
                            img.alt = '公司Logo';
                            img.style.maxHeight = '50px';
                            logoContainer.appendChild(img);
                        };
                        
                        tempImg.onerror = () => {
                            showNotification('圖片格式無效', 'error');
                        };
                        
                        tempImg.src = e.target.result;
                    } catch (err) {
                        showNotification('處理圖片時發生錯誤', 'error');
                    }
                };
                
                reader.readAsDataURL(file);
            });
        }
        
        // 設置可編輯元素
        function setupEditableElements() {
            const editables = $all('[contenteditable="true"],.editable-field');
            
            editables.forEach(el => {
                if (!el) return;
                
                el.isComposing = false;
                
                el.addEventListener("compositionstart", function() { this.isComposing = true; });
                el.addEventListener("compositionend", function() { 
                    this.isComposing = false; 
                    handleInput(this); 
                });
                
                el.addEventListener("keypress", e => {
                    if (e.key === "Enter") e.preventDefault();
                });
                
                el.addEventListener("input", function() {
                    if (!this.isComposing) handleInput(this);
                });
                
                el.addEventListener("paste", function(e) {
                    e.preventDefault();
                    const text = (e.clipboardData || window.clipboardData)
                        .getData("text")
                        .replace(/\n/g, "")
                        .trim();
                    document.execCommand("insertText", false, formatText(text, this.getAttribute("data-type")));
                    cursorHelper.setToEnd(this);
                });
            });
        }
        
        // 文本處理函數
        function handleInput(element) {
            if (!element) return;
            
            try {
                const cursorPos = saveCursorPosition(element);
                const text = formatText(
                    element.innerText.replace(/\n/g, "").trim(),
                    element.getAttribute("data-type")
                );
                
                if (text === element.innerText) return;
                
                const selection = window.getSelection();
                if (!selection) return;
                
                const range = document.createRange();
                range.selectNodeContents(element);
                selection.removeAllRanges();
                selection.addRange(range);
                document.execCommand("insertText", false, text);
                
                if (cursorPos) {
                    restoreCursorPosition(element, cursorPos);
                }
            } catch (err) {
                console.error('處理輸入錯誤:', err);
            }
        }
        
        // 格式化文本
        function formatText(text, type) {
            if (!text) return '';
            
            if (type === "phone") return text.replace(/[^0-9\s()+\-]/g, "");
            if (type === "email") return text.replace(/\s/g, "");
            return text;
        }
        
        // 保存光標位置
        function saveCursorPosition(element) {
            if (!element) return null;
            
            const selection = window.getSelection();
            if (!selection || selection.rangeCount === 0) return null;
            
            const range = selection.getRangeAt(0);
            if (!range || !element.contains(range.startContainer)) return null;
            
            return {
                start: range.startOffset,
                end: range.endOffset,
                container: range.startContainer
            };
        }
        
        // 恢復光標位置
        function restoreCursorPosition(element, position) {
            if (!element || !position) return;
            
            try {
                const selection = window.getSelection();
                if (!selection) return;
                
                // 尋找所有文字節點
                const walker = document.createTreeWalker(
                    element,
                    NodeFilter.SHOW_TEXT,
                    null,
                    false
                );
                
                // 如果沒有文字節點，添加一個
                if (!walker.nextNode()) {
                    const textNode = document.createTextNode(element.textContent || "");
                    element.textContent = '';
                    element.appendChild(textNode);
                    
                    const range = document.createRange();
                    range.setStart(textNode, 0);
                    range.setEnd(textNode, 0);
                    selection.removeAllRanges();
                    selection.addRange(range);
                    return;
                }
                
                // 重置walker
                walker.currentNode = element;
                
                // 找到第一個文字節點
                const firstTextNode = walker.nextNode();
                const textLength = firstTextNode.textContent ? firstTextNode.textContent.length : 0;
                const safePos = Math.min(position.start, textLength);
                
                const range = document.createRange();
                range.setStart(firstTextNode, safePos);
                range.setEnd(firstTextNode, safePos);
                selection.removeAllRanges();
                selection.addRange(range);
            } catch (err) {
                setCursorToEnd(element);
            }
        }
        
        // 設置光標到末尾
        function setCursorToEnd(element) {
            if (!element) return;
            
            try {
                const selection = window.getSelection();
                if (!selection) return;
                
                // 尋找最後一個文字節點
                const walker = document.createTreeWalker(
                    element,
                    NodeFilter.SHOW_TEXT,
                    null,
                    false
                );
                
                let lastTextNode = null;
                let currentNode;
                
                while (currentNode = walker.nextNode()) {
                    lastTextNode = currentNode;
                }
                
                // 如果沒有文字節點，添加一個
                if (!lastTextNode) {
                    lastTextNode = document.createTextNode("");
                    element.appendChild(lastTextNode);
                }
                
                const textLength = lastTextNode.textContent ? lastTextNode.textContent.length : 0;
                
                const range = document.createRange();
                range.setStart(lastTextNode, textLength);
                range.setEnd(lastTextNode, textLength);
                selection.removeAllRanges();
                selection.addRange(range);
            } catch (err) {
                console.error('設置游標到末尾錯誤');
            }
        }
        
        // 設置事件監聽
        function setupEventListeners() {
            const addBtn = $('addItemBtn'); 
            const delBtn = $('deleteItemBtn');
            const qTable = $('quoteTable');
            const taxType = $('taxType');
            
            if (!addBtn || !delBtn || !qTable || !taxType) return;
            
            // 增加防抖函數
            const updateTotalDebounced = debounce(() => {
                updateTotals();
                adjustLayout();
            }, 200);
            
            // 表格相關事件委派
            qTable.addEventListener('input', e => {
                const target = e.target;
                
                if (target.classList.contains('price-input') || 
                    target.classList.contains('quantity-input') ||
                    target.classList.contains('shipping-input') ||
                    target.classList.contains('installation-input')) {
                    
                    if (target.classList.contains('price-input') || 
                        target.classList.contains('shipping-input') || 
                        target.classList.contains('installation-input')) {
                        formatInputValue(target);
                    }
                    
                    updateTotalDebounced();
                }
            });
            
            // 增加表格焦點事件
            qTable.addEventListener('focusin', e => {
                const target = e.target;
                if (target.tagName === 'INPUT') {
                    target.select();
                }
            });
            
            // 鍵盤導航
            qTable.addEventListener('keydown', e => {
                if (e.key === 'Tab') {
                    const tbody = $('itemsTableBody');
                    if (!tbody) return;
                    
                    const rows = tbody.children;
                    if (!rows.length) return;
                    
                    const lastRow = rows[rows.length - 1];
                    if (!lastRow) return;
                    
                    const lastInput = lastRow.querySelector('.shipping-input');
                    if (!lastInput) return;
                    
                    if (e.target === lastInput && !e.shiftKey) {
                        e.preventDefault();
                        addRow();
                        
                        setTimeout(() => {
                            const newRow = tbody.lastChild;
                            if (!newRow) return;
                            
                            const firstInput = newRow.querySelector('.category-input');
                            if (firstInput) firstInput.focus();
                        }, 0);
                    }
                }
            });
            
            // 添加行按鈕
            addBtn.addEventListener('click', () => {
                addRow();
                adjustLayout();
            });
            
            // 刪除行按鈕
            delBtn.addEventListener('click', () => {
                const tbody = $('itemsTableBody');
                if (!tbody) return;
                
                const rows = tbody.children;
                if (rows.length > 1) {
                    rows[rows.length-1].remove();
                    updateTotals();
                    adjustLayout();
                } else {
                    showNotification("必須保留至少一行！", "warning");
                }
            });
            
            // 稅率類型變更
            taxType.addEventListener('change', updateTotalDebounced);
            
            // 文本區域自動調整高度
            const notesTextarea = $('notes-textarea');
            if (notesTextarea) {
                const adjustTextareaHeight = debounce(() => {
                    notesTextarea.style.height = 'auto';
                    notesTextarea.style.height = Math.max(80, notesTextarea.scrollHeight) + 'px';
                }, 100);
                
                notesTextarea.addEventListener('input', adjustTextareaHeight);
                notesTextarea.addEventListener('focus', adjustTextareaHeight);
            }
            
            // 增加打印前的表單驗證
            window.addEventListener('beforeprint', () => {
                if (!validateFormQuietly()) {
                    showNotification('表單有未完成的項目，打印前請先完成', 'warning');
                }
            });
        }
        
        // 格式化輸入值
        function formatInputValue(input) {
            if (!input) return;
            
            const value = input.value;
            
            if (input.classList.contains('price-input') || 
                input.classList.contains('shipping-input') || 
                input.classList.contains('installation-input')) {
                const numValue = formatHelper.parseNumber(value);
                if (numValue === 0 && value === '') {
                    return;
                }
                
                input.value = formatHelper.formatCurrency(numValue);
            }
        }
        
        // 格式化日期顯示
        function formatDate(dateString) {
            if (!dateString) return '';
            
            try {
                return new Date(dateString).toLocaleDateString('zh-TW', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
            } catch (e) {
                return dateString;
            }
        }
        
        // 添加行
        function addRow() {
            const tbody = $('itemsTableBody');
            if (!tbody) return;
            
            const newRow = document.createElement("tr");
            newRow.innerHTML = `
                <td><input type="text" class="category-input input-field" placeholder=""></td>
                <td><input type="text" class="name-input input-field" placeholder=""></td>
                <td style="text-align:center">
                    <input type="text" class="price-input input-field" value="">
                    <span class="original-price"></span>
                </td>
                <td class="text-center"><input type="number" class="quantity-input input-field" value="1" min="1"></td>
                <td class="text-center"><input type="text" class="unit-input input-field" value=""></td>
                <td class="text-center"><input type="text" class="installation-input input-field" value=""></td>
                <td class="text-center"><input type="text" class="shipping-input input-field" value=""></td>
            `;
            tbody.appendChild(newRow);
            updateTotals();
        }
        
        // 更新總計
        function updateTotals() {
            const tbody = $('itemsTableBody');
            const subtotalEl = $('subtotal');
            const totalShippingEl = $('totalShipping');
            const totalInstallationEl = $('totalInstallation');
            const depositAmountEl = $('depositAmount');
            const grandTotalEl = $('grandTotal');
            const taxTypeEl = $('taxType');
            
            if (!tbody || !grandTotalEl) return;
            
            let subtotal = 0, totalShipping = 0, totalInstallation = 0;
            
            Array.from(tbody.children).forEach(row => {
                const priceInput = row.querySelector(".price-input");
                const quantityInput = row.querySelector(".quantity-input");
                const shippingInput = row.querySelector(".shipping-input");
                const installationInput = row.querySelector(".installation-input");
                
                const price = formatHelper.parseNumber(priceInput?.value || "0");
                const quantity = Math.max(1, formatHelper.parseNumber(quantityInput?.value || "1", true));
                const shipping = formatHelper.parseNumber(shippingInput?.value || "0");
                const installation = formatHelper.parseNumber(installationInput?.value || "0");
                
                subtotal += Math.round(price * quantity);
                totalShipping += shipping;
                totalInstallation += installation;
            });
            
            const untaxedTotal = subtotal + totalShipping + totalInstallation;
            const isTaxed = taxTypeEl && taxTypeEl.value === "taxed";
            const tax = isTaxed ? Math.round(untaxedTotal * CONFIG.TAX_RATE) : 0;
            
            const grandTotal = untaxedTotal + tax;
            const depositAmount = Math.round(grandTotal * CONFIG.DEPOSIT_RATE);
            
            if (subtotalEl) subtotalEl.textContent = formatHelper.formatCurrency(subtotal);
            if (totalShippingEl) totalShippingEl.textContent = formatHelper.formatCurrency(totalShipping);
            if (totalInstallationEl) totalInstallationEl.textContent = formatHelper.formatCurrency(totalInstallation);
            if (depositAmountEl) depositAmountEl.textContent = formatHelper.formatCurrency(depositAmount);
            if (grandTotalEl) grandTotalEl.textContent = formatHelper.formatCurrency(grandTotal);
        }
        
        // 解析數值與格式化貨幣
        const formatHelper = {
            // 解析數值
            parseNumber: (value, isInteger = false) => {
                if (!value) return 0;
                
                // 轉換為字串並移除非數字字符
                let sanitized = value.toString()
                    .replace(/[^\d.-]/g, '')
                    .trim();
                
                // 處理多個小數點
                const dotIdx = sanitized.indexOf('.');
                if (dotIdx !== -1) {
                    const before = sanitized.substring(0, dotIdx + 1);
                    const after = sanitized.substring(dotIdx + 1).replace(/\./g, '');
                    sanitized = before + after;
                }
                
                // 處理多個負號
                if (sanitized.indexOf('-') !== -1) {
                    const isNeg = sanitized.charAt(0) === '-';
                    sanitized = sanitized.replace(/-/g, '');
                    if (isNeg) sanitized = '-' + sanitized;
                }
                
                try {
                    const num = isInteger ? parseInt(sanitized, 10) : parseFloat(sanitized);
                    return (isNaN(num) || !isFinite(num)) ? 0 : num;
                } catch(e) {
                    return 0;
                }
            },
            
            // 格式化貨幣
            formatCurrency: value => {
                if (isNaN(value) || !isFinite(value)) return '0';
                
                try {
                    return new Intl.NumberFormat('zh-TW', {
                        style: 'decimal',
                        minimumFractionDigits: 0,
                        maximumFractionDigits: 0
                    }).format(Math.round(value));
                } catch (e) {
                    return Math.round(value).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
                }
            }
        };
        
        // 通知系統
        function showNotification(message, type = 'info') {
            const existingNotif = document.querySelector('.notification-container');
            if (existingNotif) {
                clearTimeout(existingNotif.dataset.timerId);
                existingNotif.remove();
            }
            
            const notification = document.createElement('div');
            notification.className = `notification-container notification-${type}`;
            notification.innerHTML = `
                <div class="notification-content">
                    <span class="notification-message">${message}</span>
                    <button class="notification-close">×</button>
                </div>
            `;
            document.body.appendChild(notification);
            
            setTimeout(() => notification.classList.add('show'), 10);
            
            const closeBtn = notification.querySelector('.notification-close');
            closeBtn.addEventListener('click', () => {
                notification.classList.remove('show');
                setTimeout(() => notification.remove(), 300);
            });
            
            const timerId = setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => notification.remove(), 300);
            }, 3000);
            
            notification.dataset.timerId = timerId;
            
            return notification;
        }
        
        // 表單驗證
        function validateFormQuietly() {
            const tbody = $('itemsTableBody');
            if (!tbody) return false;
            
            // 檢查是否有填寫的商品項目
            const hasItems = Array.from(tbody.children).some(row => {
                const nameInput = row.querySelector('.name-input');
                const priceInput = row.querySelector('.price-input');
                return nameInput?.value.trim() !== '' && priceInput?.value.trim() !== '';
            });
            
            if (!hasItems) return false;
            
            // 檢查必填客戶資訊
            const clientName = document.querySelector('.client-info h4');
            return clientName && clientName.textContent.trim();
        }
        
        // 啟動應用程序
        init();
    });
    </script>
</body>
</html>
