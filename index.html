<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>百貨銷售報價單</title>
<style>
:root{--primary:#1e3a8a;--secondary:#4b5e7a;--accent:#3b82f6;--bg-light:#f8fafc;--bg-highlight:#f1f5f9;--text:#111827;--text-light:#6b7280;--border:#e5e7eb;--success:#15803d;--danger:#e53e3e}
*{margin:0;padding:0;box-sizing:border-box;font-family:Arial,sans-serif}
body{background-color:var(--bg-light);color:var(--text);line-height:1.5;font-size:14px}
::-webkit-scrollbar{width:0;height:0;background:transparent}
*{-ms-overflow-style:none;scrollbar-width:none}
.container{max-width:1000px;margin:0 auto;background-color:#fff;box-shadow:0 0 20px rgba(0,0,0,.1)}
.section{border-bottom:none;margin-bottom:0;padding-bottom:0}
.section{border:none!important}
.quote-info,.bank-totals-section,.legal-terms-section,.signature-section{background-color:var(--bg-highlight)}
.header{background-color:var(--primary)}
.items-section{background-color:#fff}
.header{color:#fff;padding:10px 20px;display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:0;padding-bottom:0;border-bottom:none;position:relative}
.company-logo{position:relative;cursor:pointer}
.company-logo:hover{opacity:.9}
.company-logo img{max-height:50px;object-fit:contain}
.upload-logo{position:absolute;width:.1px;height:.1px;opacity:0;z-index:-1}
.company-info p{opacity:.9;margin-bottom:2px;line-height:1.3}
.default-logo-text{font-size:22px;font-weight:600;color:#fff}
.document-title h2{font-size:20px;font-weight:600;margin-bottom:2px;margin-left:-20px}
.document-title p{color:rgba(255,255,255,.9);margin-bottom:2px;line-height:1.3}
.date-display{cursor:pointer;transition:opacity .2s;border-bottom:1px dashed rgba(0,0,0,.3);padding-bottom:1px;background-color:transparent}
.date-display:hover{opacity:.8;border-bottom:1px dashed rgba(0,0,0,.6)}
.document-title .date-display,.document-title .editable-field{color:#fff;border-bottom:1px dashed rgba(255,255,255,.5)}
.document-title .date-display:hover{border-bottom:1px dashed rgba(255,255,255,.8)}
.hidden-date-input{position:absolute;opacity:0;width:1px;height:1px;overflow:hidden;z-index:-1}
.content .date-display{color:var(--text);border-bottom:1px dashed var(--accent);display:inline-block;width:auto;min-width:0}
#quoteDateText,#quoteValidText,#deliveryDateText{padding-right:2px}
.quote-info{padding:8px 20px;display:grid;grid-template-columns:repeat(3,1fr);gap:15px}
.section-title,.section-title-with-controls{position:relative;padding-bottom:2px;height:20px;margin-bottom:2px;box-sizing:border-box}
.section-title{font-size:14px;text-transform:uppercase;letter-spacing:1px;color:var(--primary);font-weight:600;display:flex;align-items:center}
.section-title:after{content:'';position:absolute;left:0;bottom:0;width:36px;height:2px;background-color:var(--accent)}
.info-group{margin-bottom:6px;overflow:hidden}
.info-group h4{font-size:14px;margin-bottom:3px;color:var(--text);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.info-group p{color:var(--text-light);margin-bottom:4px;line-height:1.4;word-wrap:break-word}
.info-label{font-weight:600;display:inline-block;width:90px}
.quote-meta-row{margin-bottom:6px;line-height:1.2}
[contenteditable=true],.editable-field{border-bottom:none;padding:1px;min-height:18px;min-width:80px;display:inline-block;color:var(--text);background-color:transparent}
[contenteditable=true]:hover,.editable-field:hover{background-color:rgba(59,130,246,.1)}
[contenteditable=true]:focus,.editable-field:focus{outline:none;border-bottom:1px dashed var(--accent);background-color:rgba(59,130,246,.1)}
.items-section{padding:8px 20px}
.section-title-with-controls{display:flex;align-items:center;justify-content:space-between;margin-bottom:5px;padding-bottom:5px;border-bottom:1px solid var(--border)}
.items-controls{display:flex;align-items:center;gap:6px;margin-left:10px}
.row-btn{background:none;border:none;cursor:pointer;font-size:18px;font-weight:700;width:24px;height:24px;text-align:center;line-height:20px;transition:all .2s;padding:0}
.row-btn.add{color:var(--success)}
.row-btn.delete{color:var(--danger)}
.row-btn:hover{transform:scale(1.15);opacity:.85}
.items-section .section-title{font-size:14px;letter-spacing:1px;color:var(--primary);position:relative;padding-bottom:3px}
.items-section .section-title:after{height:2px;width:36px;border-radius:1px;bottom:-1px}
table{width:100%;border-collapse:collapse;margin-top:8px;border-radius:5px;overflow:hidden;box-shadow:0 1px 5px rgba(0,0,0,.03);border:none}
table th{background-color:var(--primary);color:#fff;text-align:left;padding:6px 8px;font-weight:600;font-size:14px;border:none;letter-spacing:.5px}
table th:first-child{border-top-left-radius:5px}
table th:last-child{border-top-right-radius:5px}
table td{padding:5px 8px;border:none;border-bottom:1px solid var(--border);vertical-align:middle;transition:all .2s ease}
table tbody tr{background-color:#fff;transition:all .2s ease}
table tbody tr:nth-child(even){background-color:var(--bg-light)}
table tbody tr:hover{background-color:var(--bg-highlight);box-shadow:0 0 3px rgba(0,0,0,.03) inset}
table tbody tr:last-child td{border-bottom:none}
table tbody tr:last-child td:first-child{border-bottom-left-radius:5px}
table tbody tr:last-child td:last-child{border-bottom-right-radius:5px}
.text-center{text-align:center}
.input-field{width:100%;padding:4px 6px;border:none;border-radius:3px;font-size:13px;transition:all .2s ease;background-color:transparent}
.price-input{text-align:center;font-weight:500;color:var(--primary)}
.quantity-input,.shipping-input,.installation-input,.unit-input{text-align:center}
.input-field:focus{outline:none;background-color:rgba(59,130,246,.08);box-shadow:0 0 0 1px rgba(59,130,246,.2)}
.input-field:hover{background-color:rgba(241,245,249,.5)}
.category-input{font-weight:500;color:var(--secondary)}
.name-input{font-weight:500}
.quantity-input::-webkit-inner-spin-button,.quantity-input::-webkit-outer-spin-button{-webkit-appearance:none;margin:0}
.quantity-input{-moz-appearance:textfield;appearance:none}
.original-price{text-decoration:line-through;color:var(--text-light);font-size:11px;display:block;text-align:center;padding-top:2px;opacity:.7}
.bank-totals-section{display:grid;grid-template-columns:1fr 1fr;gap:8px;padding:8px 20px;align-items:start}
.legal-terms-section{display:grid;grid-template-columns:1fr 1fr;gap:8px;padding:8px 20px;align-items:start}
.flex-column-container{display:flex;flex-direction:column;padding:0;margin:0}
.content-box-light{background-color:var(--bg-light);border:1px solid var(--border);border-radius:4px;padding:8px;font-size:13px;color:var(--text-light);line-height:1.4;box-shadow:0 1px 3px rgba(0,0,0,.1);overflow:visible;height:auto}
.content-box-white{background-color:#fff;border:1px solid var(--border);border-radius:4px;font-size:14px;color:var(--text-light);line-height:1.3;box-shadow:0 1px 3px rgba(0,0,0,.1);overflow:visible}
.terms-container{margin-bottom:6px;flex-shrink:0}
.terms-content{height:auto!important;overflow-y:visible!important;padding:8px 8px 4px;display:block;box-sizing:border-box}
.terms-list{padding-left:16px;padding-bottom:0;list-style-type:disc;margin:0;width:100%;font-size:12px}
.terms-list li{margin-bottom:2px;padding-bottom:0;line-height:1.25;font-size:12px}
.terms-list li:last-child{margin-bottom:0}
.right-side-container{display:flex;flex-direction:column;height:100%}
.notes-container{position:relative;width:100%;padding:0;flex-grow:1;display:flex;flex-direction:column;margin-top:6px;min-height:90px}
#notes-textarea{width:100%;margin:0;padding:8px;height:65px;min-height:65px;max-height:none;font-size:12px;line-height:1.25;flex-grow:1;transition:none;-webkit-appearance:none;resize:vertical;box-sizing:border-box;border:1px solid var(--border);background-color:var(--bg-light);color:var(--text-light);overflow:hidden!important;scrollbar-width:none!important;-ms-overflow-style:none!important;overflow-y:hidden!important;overflow-x:hidden!important}
#notes-textarea::-webkit-scrollbar,#notes-textarea::-webkit-scrollbar-thumb,#notes-textarea::-webkit-scrollbar-track,#notes-textarea::-webkit-scrollbar-corner{display:none!important;width:0!important;height:0!important;background:transparent!important;visibility:hidden!important}
#notes-print-preview{display:none;width:100%;padding:8px;font-size:12px;line-height:1.25;min-height:65px;box-sizing:border-box;border:1px solid var(--border);background-color:var(--bg-light);color:var(--text-light);white-space:pre-wrap;word-wrap:break-word;overflow:hidden;border-radius:4px}
textarea::-webkit-scrollbar{display:none!important;width:0!important;height:0!important}
.legal-notice-container{height:auto;display:flex;flex-direction:column}
.legal-notice{height:auto;flex-grow:1;display:flex;flex-direction:column;overflow:visible}
.legal-notice h4{color:var(--primary);margin-bottom:4px;font-size:15px}
.legal-notice p{margin-bottom:5px}
.warranty-term-table{width:100%;border-collapse:collapse;margin:4px 0}
.warranty-term-table td{padding:3px 5px;border:1px solid var(--border);font-size:12px}
.warranty-term-table .term-label{width:20%;font-weight:600;background-color:rgba(75,94,122,.1);color:var(--primary)}
.totals-table{width:100%;border:none;background-color:#fff;border-radius:4px}
.totals-row{height:24px;display:flex;align-items:center}
.totals-row.totals-final{margin-top:auto;border-top:1px solid var(--border);padding-top:3px;height:28px}
.totals-label{width:60%;color:var(--text-light);font-size:13px;padding-left:5px}
.totals-value{width:40%;text-align:right;font-weight:600;font-size:13px;padding-right:5px}
.clean-select{appearance:none;border:none;background:transparent;width:100%;font-size:13px;font-weight:600;color:var(--text-light);cursor:pointer;outline:none;line-height:1.2}
.bank-info-container,.totals-container{height:180px;display:flex;flex-direction:column}
.bank-info,.totals-table{box-sizing:border-box;padding:6px 8px;flex-grow:1;display:flex;flex-direction:column;margin-top:3px}
.bank-info .info-group{margin:0;display:flex;flex-direction:column;justify-content:space-between;height:100%}
.bank-info .info-label{width:75px;font-weight:600;font-size:13px;display:inline-block;color:var(--text-light);line-height:1.2}
.bank-info .info-group p{font-size:13px;line-height:1.2;margin-bottom:0;padding:2px 0;height:24px;display:flex;align-items:center;overflow:hidden}
.bank-info span[contenteditable="true"]{font-size:13px;font-weight:600;line-height:1.2;min-height:18px;display:inline-block;overflow:hidden}
.signature-section{width:100%;display:flex;justify-content:space-between;padding:10px 20px;gap:12px;align-items:stretch}
.staff-info,.client-confirmation{width:48%;text-align:left;background-color:#fff;padding:10px;border:1px solid var(--border);border-radius:4px;display:flex;flex-direction:column;height:100%}
.staff-info .info-group,.client-confirmation .info-group{margin-top:4px;margin-bottom:0;flex:1;display:flex;flex-direction:column;justify-content:space-between}
.staff-info .info-label,.client-confirmation .info-label{width:70px}
.notification-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background-color:rgba(0,0,0,.5);display:flex;align-items:center;justify-content:center;z-index:9999;opacity:0;visibility:hidden;transition:opacity .3s,visibility .3s}
.notification-overlay.show{opacity:1;visibility:visible}
.notification-modal{background:#fff;border-radius:8px;width:90%;max-width:450px;box-shadow:0 10px 25px rgba(0,0,0,.25);transform:translateY(-20px);transition:transform .3s;overflow:hidden}
.notification-overlay.show .notification-modal{transform:translateY(0)}
.notification-header{padding:12px 16px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between}
.notification-title{font-weight:600;font-size:18px;display:flex;align-items:center;gap:10px}
.notification-icon{display:flex;align-items:center;justify-content:center}
.notification-icon svg{flex-shrink:0}
.notification-content{padding:20px 16px;font-size:16px;line-height:1.5}
.notification-footer{padding:12px 16px;border-top:1px solid var(--border);display:flex;justify-content:flex-end}
.notification-btn{background-color:var(--primary);color:#fff;border:none;border-radius:4px;padding:8px 16px;font-weight:600;cursor:pointer;transition:background-color .2s;font-size:14px}
.notification-btn:hover{background-color:#163172}
.notification-warning .notification-title{color:#f59e0b}
.notification-error .notification-title{color:var(--danger)}
.info-group-text{margin-bottom:4px;line-height:1.4;word-wrap:break-word;color:var(--text-light)}
@media(max-width:768px){.container{margin:0;width:100%}.header{flex-direction:column;align-items:center;text-align:center;padding:15px}.document-title{margin-top:15px;width:100%;text-align:center}.quote-info{display:flex;flex-direction:column;padding:10px 15px}.client-info,.quote-details,.contact-info{width:100%;margin-bottom:15px}.legal-terms-section,.bank-totals-section{display:flex;flex-direction:column;gap:15px;padding:15px}.legal-notice-container,.totals-container,.bank-info-container,.right-side-container{width:100%}.items-section{padding:10px 15px;overflow-x:auto}.table-responsive{overflow-x:auto}table{width:100%}.signature-section{flex-direction:column;padding:15px}.staff-info,.client-confirmation{width:100%;margin-bottom:10px}}
@media (min-width:769px) and (max-width:992px){.container{margin:0 auto;width:95%}.legal-terms-section,.bank-totals-section{gap:12px}.section-title{font-size:13px}}
@media print{
  *{-webkit-print-color-adjust:exact!important;print-color-adjust:exact!important;color-adjust:exact!important}
  body,html{width:100%;height:auto;margin:0;padding:0;background-color:#fff!important}
  .container{width:100%!important;max-width:none!important;margin:0!important;box-shadow:none!important;padding:0!important;background-color:#fff!important}
  .header{background-color:var(--primary)!important;color:#fff!important;print-color-adjust:exact!important;-webkit-print-color-adjust:exact!important}
  .bank-totals-section,.legal-terms-section,.quote-info,.signature-section{background-color:var(--bg-highlight)!important;print-color-adjust:exact!important;-webkit-print-color-adjust:exact!important}
  table th{background-color:var(--primary)!important;color:#fff!important;print-color-adjust:exact!important;-webkit-print-color-adjust:exact!important}
  .bank-info,.content-box-light,.legal-notice{background-color:var(--bg-light)!important;print-color-adjust:exact!important;-webkit-print-color-adjust:exact!important}
  .editable-field,[contenteditable=true],input.input-field{border:none!important;background-color:transparent!important;-webkit-appearance:none!important;box-shadow:none!important;-webkit-print-color-adjust:exact!important;print-color-adjust:exact!important}
  .items-controls,.notification-overlay,.row-btn,.upload-logo{display:none!important}
  .header,.quote-info,.bank-totals-section,.legal-terms-section,.signature-section,.items-section{break-inside:avoid!important;page-break-inside:avoid!important}
  .items-section{break-inside:auto!important;page-break-inside:auto!important}
  #itemsTableBody tr{break-inside:avoid!important;page-break-inside:avoid!important}
  table thead{display:table-header-group!important}
  
  @page{size:A4 portrait;margin:0}
  
  .header{padding:5px 15px!important}
  .company-logo img{max-height:40px!important}
  .default-logo-text{font-size:18px!important;color:#fff!important;print-color-adjust:exact!important;-webkit-print-color-adjust:exact!important}
  .company-info p{font-size:11px!important;margin-bottom:1px!important;line-height:1.2!important;color:#fff!important;print-color-adjust:exact!important;-webkit-print-color-adjust:exact!important}
  .document-title h2{font-size:18px!important;margin-bottom:1px!important;color:#fff!important;print-color-adjust:exact!important;-webkit-print-color-adjust:exact!important}
  .document-title p{font-size:11px!important;margin-bottom:1px!important;line-height:1.2!important;color:#fff!important;print-color-adjust:exact!important;-webkit-print-color-adjust:exact!important}
  
  .section{margin-bottom:0!important;padding-bottom:0!important}
  .bank-totals-section,.items-section,.legal-terms-section,.quote-info,.signature-section{padding:5px 15px!important}
  .bank-totals-section .section-title,.items-section .section-title,.legal-terms-section .section-title,.quote-info .section-title,.signature-section .section-title{
    font-size:12px!important;height:16px!important;margin-bottom:1px!important;color:var(--primary)!important;print-color-adjust:exact!important;-webkit-print-color-adjust:exact!important
  }
  
  .quote-info .info-group h4{font-size:12px!important;margin-bottom:1px!important}
  .bank-info .info-group p,.client-confirmation .info-group p,.quote-info .info-group p,.staff-info .info-group p{
    font-size:11px!important;margin-bottom:1px!important;line-height:1.2!important
  }
  .bank-info .info-label,.client-confirmation .info-label,.quote-info .info-label,.staff-info .info-label{
    width:70px!important;font-size:11px!important
  }
  
  table{width:100%!important;font-size:11px!important;margin-top:3px!important;box-shadow:none!important;border:1px solid var(--border)!important;border-radius:4px!important}
  table th{padding:3px 4px!important;font-size:11px!important;background-color:var(--primary)!important;color:#fff!important;print-color-adjust:exact!important;-webkit-print-color-adjust:exact!important}
  table td{padding:2px 4px!important}
  table tbody tr:nth-child(even){background-color:rgba(241,245,249,.5)!important;print-color-adjust:exact!important;-webkit-print-color-adjust:exact!important}
  
  .input-field{font-size:11px!important;padding:1px!important}
  .terms-list li{font-size:10px!important;margin-bottom:1px!important;line-height:1.2!important}
  .legal-notice p{font-size:10px!important;margin-bottom:2px!important;line-height:1.2!important}
  .legal-notice h4{font-size:12px!important;margin-bottom:2px!important;color:var(--primary)!important;print-color-adjust:exact!important;-webkit-print-color-adjust:exact!important}
  
  .warranty-term-table td{padding:1px 2px!important;font-size:9px!important}
  .warranty-term-table .term-label{background-color:rgba(75,94,122,.1)!important;color:var(--primary)!important;print-color-adjust:exact!important;-webkit-print-color-adjust:exact!important}
  
  .totals-table .totals-row{height:18px!important}
  .clean-select,.totals-label,.totals-value{font-size:11px!important}
  .client-confirmation,.staff-info{padding:5px!important}
  
  #notes-textarea{
    resize:none!important;
    height:auto!important;
    min-height:40px!important;
    font-size:10px!important;
    overflow:visible!important;
    display:block!important;
    background-color:var(--bg-light)!important;
    color:var(--text-light)!important;
    print-color-adjust:exact!important;
    -webkit-print-color-adjust:exact!important;
    white-space:pre-wrap!important;
    word-wrap:break-word!important;
    border:1px solid var(--border)!important;
  }
  
  .legal-terms-section, .bank-totals-section{
    display:grid!important;
    grid-template-columns:1fr 1fr!important;
    gap:8px!important;
    page-break-inside:avoid!important;
    break-inside:avoid!important;
  }
  
  .signature-section{
    display:flex!important;
    flex-direction:row!important;
    page-break-inside:avoid!important;
    break-inside:avoid!important;
  }
  
  .staff-info, .client-confirmation{
    width:48%!important;
    background-color:#fff!important;
    print-color-adjust:exact!important;
    -webkit-print-color-adjust:exact!important;
  }
  
  .quote-info{
    display:grid!important;
    grid-template-columns:repeat(3,1fr)!important;
    gap:10px!important;
    padding:6px 16px!important;
  }
  
  .content-box-white{
    background-color:#fff!important;
    print-color-adjust:exact!important;
    -webkit-print-color-adjust:exact!important;
  }
  
  .right-side-container{
    display:flex!important;
    flex-direction:column!important;
  }
  
  .terms-content, .notes-container{
    display:block!important;
    height:auto!important;
    overflow:visible!important;
  }
  
  /* 新增: 確保表格正確顯示 */
  #quoteTable {
    width: 100% !important;
    table-layout: fixed !important;
    page-break-inside: auto !important;
    border: 1px solid var(--border) !important;
  }
  
  /* 確保表格頭部在每頁都顯示 */
  #quoteTable thead {
    display: table-header-group !important;
  }
  
  /* 確保每個單元格不會被壓縮或截斷 */
  #quoteTable th, #quoteTable td {
    box-sizing: border-box !important;
    overflow: visible !important;
    page-break-inside: avoid !important;
  }
  
  /* 修復空行或被隱藏的行 */
  #itemsTableBody tr {
    display: table-row !important;
    visibility: visible !important;
    height: auto !important;
    min-height: 24px !important;
  }
  
  /* 確保空白輸入欄位仍然可見 */
  .input-field {
    background-color: transparent !important;
    border: 1px solid #e5e7eb !important;
    min-height: 18px !important;
    display: block !important;
    width: 100% !important;
  }

  /* 確保備註內容在列印時完整顯示 */
  .notes-container {
    page-break-inside: avoid !important;
    break-inside: avoid !important;
  }
  
  #notes-textarea {
    display: none !important; /* 在列印時隱藏 */
  }
  
  #notes-print-content {
    display: block !important;
    width: 100% !important;
    min-height: 40px !important;
    font-size: 10px !important;
    line-height: 1.25 !important;
    white-space: pre-wrap !important;
    word-wrap: break-word !important;
    color: var(--text-light) !important;
    background-color: var(--bg-light) !important;
    border: 1px solid var(--border) !important;
    border-radius: 4px !important;
    padding: 8px !important;
    margin-top: 3px !important;
    overflow: visible !important;
    page-break-inside: avoid !important;
    break-inside: avoid !important;
  }
}
.client-info{position:relative;transition:all .2s ease;padding:4px 8px;border-radius:4px;border:1px solid transparent;margin:-1px}.client-info:hover{background-color:rgba(241,245,249,.5);border-color:var(--border);box-shadow:0 1px 4px rgba(0,0,0,.05)}.client-info .section-title{color:var(--primary);font-weight:600;margin-bottom:5px;padding-bottom:2px;height:18px;font-size:13px}.client-info .section-title:after{height:2px;width:32px}.client-info .info-group h4{font-weight:600;color:var(--primary);margin-bottom:3px;font-size:14px}.client-info .info-group p{margin-bottom:3px;line-height:1.3}.client-info .editable-field{border-bottom:1px dashed rgba(203,213,225,.5);padding:1px 3px;border-radius:2px;transition:all .2s ease;min-width:100px;min-height:16px}.client-info .editable-field:empty{min-height:18px;background-color:rgba(241,245,249,.3)}.client-info p:last-child{margin-bottom:1px}@media print{.client-info{padding:0;background-color:transparent!important;border-color:transparent!important;box-shadow:none!important}.client-info .editable-field{border-bottom:none!important;box-shadow:none!important;background-color:transparent!important}}
.contact-info,.quote-details{position:relative;padding:4px 8px;border-radius:4px;border:1px solid transparent;margin:-1px}.contact-info:hover,.quote-details:hover{background-color:rgba(241,245,249,.5);border-color:var(--border);box-shadow:0 1px 4px rgba(0,0,0,.05)}.contact-info .section-title,.quote-details .section-title{margin-bottom:5px;padding-bottom:2px;height:18px;font-size:13px}.contact-info .info-group p,.quote-details .info-group p{margin-bottom:2px;line-height:1.3}.quote-info{gap:10px;padding:6px 16px}.quote-details .info-group{margin-top:4px}
</style>
</head>
<body>
<div class="container">
<div class="header section">
<div class="company-info">
<div class="company-logo" id="logo-container"><span class="default-logo-text">玖星吉國際貿易</span></div>
<input type="file" id="upload-logo" class="upload-logo" accept="image/*">
<p>統編：89061654</p><p>電話：02-7709-4666</p><p>信箱：service@9starmax.com</p>
</div>
<div class="document-title">
<h2>商品報價單</h2>
<p>報價單號：<span id="quoteNumber"></span></p>
<p id="quoteDateContainer">報價日期：<span id="quoteDateText" class="date-display editable-field"></span><input type="date" id="quoteDate" class="hidden-date-input"></p>
<p id="quoteValidContainer">有效期限：<span id="quoteValidText" class="date-display editable-field"></span><input type="date" id="quoteValidUntil" class="hidden-date-input"></p>
</div>
</div>
<div class="content">
<div class="quote-info section">
<div class="client-info">
<div class="section-title">客戶資訊</div>
<div class="info-group">
<h4 contenteditable="true" data-placeholder="請輸入客戶名稱" class="editable-field"></h4>
<p contenteditable="true" data-placeholder="請輸入客戶地址" class="editable-field"></p>
<p>統一編號：<span contenteditable="true" data-placeholder="請輸入統一編號" class="editable-field"></span></p>
</div>
</div>
<div class="contact-info">
<div class="section-title">聯絡窗口</div>
<div class="info-group">
<p><span class="info-label">聯絡人：</span> <span contenteditable="true" data-placeholder="請輸入聯絡人資訊" class="editable-field"></span></p>
<p><span class="info-label">電話：</span> <span contenteditable="true" data-placeholder="請輸入電話號碼" data-type="phone" class="editable-field"></span></p>
<p><span class="info-label">電子郵件：</span> <span contenteditable="true" data-placeholder="請輸入電子郵件" data-type="email" class="editable-field"></span></p>
</div>
</div>
<div class="quote-details">
<div class="section-title">報價資訊</div>
<div class="info-group">
<p class="quote-meta-row"><span class="info-label">預計交期：</span><span id="deliveryDateText" class="date-display editable-field"></span><input type="date" id="deliveryDate" class="hidden-date-input"></p>
<p class="quote-meta-row"><span class="info-label">支付條件：</span><span>經確認報價後支付30%訂金</span></p>
<p class="quote-meta-row"><span class="info-label" style="color:transparent">支付條件：</span><span>商品交付後<span contenteditable="true" data-placeholder="天數" class="editable-field" style="min-width:20px;width:auto;display:inline-block;text-align:center;border-bottom:1px dashed var(--border);margin:0 2px;padding:0">30</span>天內結清尾款</span></p>
</div>
</div>
</div>
<div class="items-section section">
<div class="section-title-with-controls">
<div class="section-title">報價商品明細</div>
<div class="items-controls">
<button class="row-btn add" id="addItemBtn" title="增加一行">+</button>
<button class="row-btn delete" id="deleteItemBtn" title="刪除最後一行">−</button>
</div>
</div>
<div class="table-responsive">
<table id="quoteTable">
<thead>
<tr>
<th style="width:15%">種類</th>
<th style="width:30%">名稱</th>
<th style="width:15%" class="text-center">單價</th>
<th style="width:10%" class="text-center">數量</th>
<th style="width:10%" class="text-center">單位</th>
<th style="width:10%" class="text-center">安裝</th>
<th style="width:10%" class="text-center">運費</th>
</tr>
</thead>
<tbody id="itemsTableBody">
<tr>
<td><input type="text" class="category-input input-field" placeholder=""></td>
<td><input type="text" class="name-input input-field" placeholder=""></td>
<td style="text-align:center">
<input type="text" class="price-input input-field" value="">
<span class="original-price"></span>
</td>
<td class="text-center"><input type="number" class="quantity-input input-field" value="" min="0" step="0.01"></td>
<td class="text-center"><input type="text" class="unit-input input-field" value=""></td>
<td class="text-center"><input type="text" class="installation-input input-field" value=""></td>
<td class="text-center"><input type="text" class="shipping-input input-field" value=""></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="bank-totals-section section">
<div class="bank-info-container flex-column-container">
<div class="section-title">銀行資訊</div>
<div class="bank-info content-box-white">
<div class="info-group">
<p><span class="info-label">金融機構：</span><span contenteditable="true" data-placeholder="請輸入金融機構" class="editable-field">第一銀行</span></p>
<p><span class="info-label">機構分支：</span><span contenteditable="true" data-placeholder="請輸入機構分支" class="editable-field">東港分行</span></p>
<p><span class="info-label">金融戶名：</span><span contenteditable="true" data-placeholder="請輸入金融戶名" class="editable-field">玖吉發貿易行</span></p>
<p><span class="info-label">金融代碼：</span><span contenteditable="true" data-placeholder="請輸入金融代碼" class="editable-field">007</span></p>
<p><span class="info-label">金融帳號：</span><span contenteditable="true" data-placeholder="請輸入金融帳號" class="editable-field">7521-0068-870</span></p>
</div>
</div>
</div>
<div class="totals-container flex-column-container">
<div class="section-title">總計金額</div>
<div class="totals-table content-box-white">
<div class="totals-row"><span class="totals-label">商品合計</span><span class="totals-value" id="subtotal">0</span></div>
<div class="totals-row"><span class="totals-label">安裝費用</span><span class="totals-value" id="totalInstallation">0</span></div>
<div class="totals-row"><span class="totals-label">運送費用</span><span class="totals-value" id="totalShipping">0</span></div>
<div class="totals-row"><span class="totals-label">預付訂金</span><span class="totals-value" id="depositAmount">0</span></div>
<div class="totals-row totals-final">
<span class="totals-label">
<select id="taxType" class="clean-select">
<option value="untaxed" selected>未稅總計金額</option>
<option value="taxed">應稅總計金額</option>
</select>
</span>
<span class="totals-value" id="grandTotal">0</span>
</div>
</div>
</div>
</div>
<div class="legal-terms-section section">
<div class="legal-notice-container">
<div class="section-title">法律聲明與注意事項</div>
<div class="legal-notice content-box-light">
<h4>契約法律關係說明</h4>
<p>依據中華民國民法第153條及消費者保護法第4條規定，本報價單一經貴方接受並確認，即構成具有法律約束力之買賣契約，雙方均應依誠信原則履行契約義務。</p>
<h4>商品瑕疵責任</h4>
<p>依據民法第354條及第355條規定，本公司就所出售之商品，擔保其於危險移轉時無滅失或減少其價值之瑕疵，並擔保其具有特定保證之品質。如有瑕疵，買方得依民法第359條主張減少價金或解除契約。</p>
<h4>保固與維修責任</h4>
<div class="warranty-terms">
<table class="warranty-term-table">
<tr><td class="term-label">保固範圍</td><td>依商品保固書登載為準未特別約定自交付日起算七日</td></tr>
<tr><td class="term-label">保固服務</td><td>保固期內因製造瑕疵損壞，提供免費維修或更換服務</td></tr>
<tr><td class="term-label">除外情形</td><td>人為、天災、未經授權拆改或正常耗損導致損壞不保</td></tr>
<tr><td class="term-label">特殊約定</td><td>除個別報價單內另有約定之事項條款者，為優先適用</td></tr>
<tr><td class="term-label">法定權益</td><td>不影響消費者依《消費者保護法》享有的7天鑑賞期等權利</td></tr>
</table>
</div>
<h4>個人資料保護聲明</h4>
<p>依據個人資料保護法規定，本公司蒐集、處理及利用貴方之個人資料，僅限於本交易及售後服務之目的範圍內。貴方享有查詢、閱覽、複製、補充、更正、刪除及停止蒐集處理利用之權利。</p>
<h4 style="margin-bottom:4px">版權免責聲明</h4>
<p style="margin-bottom:0">若貴方提供圖樣、設計或其他內容進行客製化商品製作，貴方需確保擁有該等內容之合法使用權或著作權。對於貴方提供之任何可能涉及第三方著作權、商標權或其他智慧財產權之內容，本公司不負審查義務及侵權責任。若因此導致任何法律爭議或損害，應由貴方承擔全部責任並賠償本公司因此遭受之損失。本公司保留拒絕處理任何疑似侵權內容之權利。</p>
</div>
</div>
<div class="right-side-container">
<div class="terms-container">
<div class="section-title">合約條款與條件</div>
<div class="terms-content content-box-light">
<ul class="terms-list">
<li>本報價單自開立日起7天內有效，逾期未接受者視為自動失效。</li>
<li>政府機關、公立學校採購適用政府採購法相關規定，如有牴觸，以政府採購法為準。</li>
<li>實際交付之商品顏色、紋理可能因生產批次及自然材質特性而有些微差異，此非屬產品瑕疵。</li>
<li>所有金額以新台幣計價，包含基本運送與安裝費用，但不含因現場特殊情況衍生之額外工程費用。</li>
<li>驗收時請確實檢查商品外觀及功能，簽收後視為接受商品現況。如有明顯瑕疵，請於驗收時立即提出。</li>
<li>報價單確認無誤，需支付總金額30%作為訂金，餘款支付方式若合約另有約定則從其約定，否則應於驗收合格後30日內付清。</li>
<li>標準交期為確認訂單後4-8週，實際交期將依訂單確認書為準。遇原物料短缺或不可抗力因素，交期可能順延，本公司將立即通知。</li>
</ul>
</div>
</div>
<div class="notes-container">
<div class="section-title">其他備註</div>
<textarea id="notes-textarea" class="content-box-light"></textarea>
</div>
</div>
</div>
<div class="signature-section section">
<div class="staff-info" id="staff-info">
<div class="section-title" id="staff-title">銷售方資訊</div>
<div class="info-group">
<p><span class="info-label">姓名：</span> <span contenteditable="true" class="editable-field"></span></p>
<p><span class="info-label">電話：</span> <span contenteditable="true" data-type="phone" class="editable-field">02-7709-4666</span></p>
<p><span class="info-label">信箱：</span> <span contenteditable="true" data-type="email" class="editable-field">Service@9Starmax.com</span></p>
</div>
</div>
<div class="client-confirmation" id="client-confirmation">
<div class="section-title" id="client-title">採購方資訊</div>
<div class="info-group">
<p><span class="info-label">姓名：</span> <span contenteditable="true" data-placeholder="請輸入客戶姓名" class="editable-field"></span></p>
<p><span class="info-label">電話：</span> <span contenteditable="true" data-placeholder="請輸入電話號碼" data-type="phone" class="editable-field"></span></p>
<p><span class="info-label">信箱：</span> <span contenteditable="true" data-placeholder="請輸入電子郵件" data-type="email" class="editable-field"></span></p>
</div>
</div>
</div>
</div>
</div>
<script>
document.addEventListener('DOMContentLoaded',()=>{const C={TAX_RATE:.05,DEPOSIT_RATE:.3,DEFAULT_VALID_DAYS:7,DEFAULT_DELIVERY_DAYS:20,MAX_VALUE:999999999,MIN_VALUE:-999999999},M=["JA","FE","MR","AP","MY","JN","JL","AU","SE","OC","NO","DE"],T=new Date,d=e=>document.getElementById(e),a=e=>document.querySelectorAll(e),D={quoteDateText:'quoteDate',quoteValidText:'quoteValidUntil',deliveryDateText:'deliveryDate'},b=(e,t)=>{let r;return function(){clearTimeout(r),r=setTimeout(()=>e.apply(this,arguments),t)}},F={parseNumber:(e,t=!1)=>{if(!e)return 0;try{const r=String(e).replace(/[^\d.-]/g,'').trim(),n=t?parseInt(r):parseFloat(r);return isNaN(n)?0:Math.min(C.MAX_VALUE,Math.max(C.MIN_VALUE,n))}catch{return 0}},formatCurrency:e=>{if(isNaN(e))return'0';try{const t=Math.round(Math.min(C.MAX_VALUE,Math.max(C.MIN_VALUE,e)));return new Intl.NumberFormat('zh-TW',{style:'decimal',minimumFractionDigits:0,maximumFractionDigits:0}).format(t)}catch{return Math.round(e).toString().replace(/\B(?=(\d{3})+(?!\d))/g,",")}},formatText:(e,t)=>{if(!e)return'';if(t==="phone")return e.replace(/[^\d\s()+\-]/g,"").substring(0,20);if(t==="email")return e.replace(/\s/g,"").substring(0,50);return e.substring(0,500)},formatDate:e=>{if(!e)return'';try{return new Date(e).toLocaleDateString('zh-TW',{year:'numeric',month:'long',day:'numeric'})}catch{return e}}};function S(e){if(!e)return;const t=e.value;e.style.height='auto';const r=Math.max(65,e.scrollHeight+5);e.style.height=r+'px'}function P(){
  // 直接創建備註內容預覽元素，而不是等到列印時
  const notesTextarea = document.getElementById('notes-textarea');
  if (notesTextarea) {
    let notesPreviewDiv = document.getElementById('notes-print-preview');
    if (!notesPreviewDiv) {
      notesPreviewDiv = document.createElement('div');
      notesPreviewDiv.id = 'notes-print-preview';
      notesPreviewDiv.className = 'content-box-light';
      notesPreviewDiv.style.display = 'none';
      notesPreviewDiv.style.whiteSpace = 'pre-wrap';
      notesPreviewDiv.style.wordWrap = 'break-word';
      // 插入到備註容器中但在textarea之後
      notesTextarea.insertAdjacentElement('afterend', notesPreviewDiv);
    }
    
    // 同步備註文本到預覽元素
    function syncNotesText() {
      notesPreviewDiv.textContent = notesTextarea.value;
    }
    
    // 初始同步
    syncNotesText();
    
    // 監聽文本變化以同步到預覽元素
    notesTextarea.addEventListener('input', syncNotesText);
  }

  window.addEventListener('beforeprint', () => {
    // 找到備註相關元素
    const notesTextarea = document.getElementById('notes-textarea');
    const notesPreviewDiv = document.getElementById('notes-print-preview');
    
    // 如果找到這些元素，則進行打印準備
    if (notesTextarea && notesPreviewDiv) {
      // 隱藏編輯區域，顯示預覽區域
      notesTextarea.style.display = 'none';
      notesPreviewDiv.style.display = 'block';
      // 最後同步一次內容，確保最新
      notesPreviewDiv.textContent = notesTextarea.value;
    }
    
    // 處理可編輯區域，隱藏空白區域
    document.querySelectorAll('[contenteditable="true"], .editable-field').forEach(t => {
      t.dataset.originalBorder = t.style.border;
      t.style.border = 'none';
      if (!t.textContent.trim()) {
        t.dataset.wasEmpty = "true";
        t.style.color = 'transparent';
      }
    });
    
    // 處理輸入框，隱藏空白輸入框
    document.querySelectorAll('input.input-field').forEach(t => {
      if (!t.value) {
        t.dataset.wasEmpty = "true";
        t.style.color = 'transparent';
      }
    });
    
    // 修改：確保表格總是顯示7行
    const tbody = document.getElementById('itemsTableBody');
    if (tbody) {
      const rows = tbody.querySelectorAll('tr');
      const visibleRows = Array.from(rows).filter(row => 
        row.style.display !== 'none' && !row.dataset.hiddenForPrint);
      
      // 保持至少7行可見
      if (visibleRows.length < 7) {
        // 先恢復被標記為隱藏的行
        rows.forEach(row => {
          if (row.dataset.hiddenForPrint === "true" || row.dataset.wasEmpty === "true") {
            row.style.display = 'table-row';
            delete row.dataset.hiddenForPrint;
            delete row.dataset.wasEmpty;
          }
        });
        
        // 如果行數仍不足7行，則添加新行
        if (rows.length < 7) {
          const rowsToAdd = 7 - rows.length;
          for (let i = 0; i < rowsToAdd; i++) {
            const newRow = document.createElement('tr');
            newRow.innerHTML = rows[0].innerHTML; // 複製第一行的結構
            
            // 清空所有輸入值
            newRow.querySelectorAll('input').forEach(input => {
              input.value = '';
              input.style.border = '1px solid #e5e7eb';
            });
            
            tbody.appendChild(newRow);
          }
        }
      }
      
      // 確保輸入欄位在列印時可見
      tbody.querySelectorAll('input').forEach(input => {
        if (!input.value.trim()) {
          input.style.border = '1px solid #e5e7eb';
          input.style.minHeight = '18px';
        }
      });
    }
    
    // 確保顏色正確顯示
    document.querySelectorAll('.header, .header *, table th, .warranty-term-table .term-label').forEach(el => {
      el.style.webkitPrintColorAdjust = 'exact';
      el.style.printColorAdjust = 'exact';
    });
    
    // 隱藏通知彈窗
    const o = document.querySelector('.notification-overlay.show');
    if (o) o.classList.remove('show');
  });

  window.addEventListener('afterprint', () => {
    // 找到備註相關元素
    const notesTextarea = document.getElementById('notes-textarea');
    const notesPreviewDiv = document.getElementById('notes-print-preview');
    
    // 如果找到這些元素，則進行打印後還原
    if (notesTextarea && notesPreviewDiv) {
      // 顯示編輯區域，隱藏預覽區域
      notesTextarea.style.display = 'block';
      notesPreviewDiv.style.display = 'none';
      // 調整文本區域高度
      S(notesTextarea);
    }
    
    // 還原可編輯區域
    document.querySelectorAll('[contenteditable="true"], .editable-field').forEach(t => {
      if (t.dataset.originalBorder) {
        t.style.border = t.dataset.originalBorder;
        delete t.dataset.originalBorder;
      }
      if (t.dataset.wasEmpty === "true") {
        t.textContent = '';
        t.style.color = '';
        delete t.dataset.wasEmpty;
      }
    });
    
    // 還原輸入框
    document.querySelectorAll('input.input-field').forEach(t => {
      if (t.dataset.wasEmpty === "true") {
        t.value = '';
        t.style.color = '';
        delete t.dataset.wasEmpty;
      }
    });
    
    // 還原表格行
    document.querySelectorAll('tr[data-hidden-for-print="true"]').forEach(t => {
      t.style.display = '';
      delete t.dataset.hiddenForPrint;
    });
    
    // 新增：移除多餘的行（如果超過7行）
    const tbody = document.getElementById('itemsTableBody');
    if (tbody) {
      const rows = tbody.querySelectorAll('tr');
      if (rows.length > 7) {
        Array.from(rows).slice(7).forEach(row => row.remove());
      }
    }
  });
}function A(){
  // 添加更完整的列印樣式
  const e=document.createElement('style');
  e.textContent=`
@media print{
  /* 通用列印設置 */
  body,html,*{-webkit-print-color-adjust:exact!important;print-color-adjust:exact!important;color-adjust:exact!important}
  
  /* 確保顏色設置正確顯示 */
  .header{background-color:var(--primary)!important;color:#fff!important}
  .header *{color:#fff!important}
  .default-logo-text{color:#fff!important}
  .document-title *{color:#fff!important}
  
  /* 表格標題的顏色 */
  table th{background-color:var(--primary)!important;color:#fff!important}
  
  /* 確保區域間避免分頁 */
  .bank-totals-section, .legal-terms-section, .header, .quote-info, .signature-section{
    page-break-inside:avoid!important;
    break-inside:avoid!important;
  }
  
  /* 備註內容的特殊處理 */
  .notes-container {
    page-break-inside: avoid!important;
    break-inside: avoid!important;
    position: relative;
  }
  
  /* 隱藏原始文本框，顯示打印內容 */
  @media print {
    #notes-textarea {
      display: none!important;
    }
    
    #notes-print-content {
      display: block!important;
      width: 100%!important;
      min-height: 40px!important;
      font-size: 10px!important;
      line-height: 1.25!important;
      white-space: pre-wrap!important;
      word-wrap: break-word!important;
      color: var(--text-light)!important;
      background-color: var(--bg-light)!important;
      border: 1px solid var(--border)!important;
      border-radius: 4px!important;
      padding: 8px!important;
      margin-top: 3px!important;
      overflow: visible!important;
      page-break-inside: avoid!important;
      break-inside: avoid!important;
    }
  }
  
  /* 確保網格布局正確顯示 */
  .bank-totals-section, .legal-terms-section{
    display:grid!important;
    grid-template-columns:1fr 1fr!important;
    gap:8px!important;
  }
  
  .right-side-container{
    display:flex!important;
    flex-direction:column!important;
    height:auto!important;
  }
  
  .quote-info{
    display:grid!important;
    grid-template-columns:repeat(3,1fr)!important;
    gap:10px!important;
  }
  
  .signature-section{
    display:flex!important;
    flex-direction:row!important;
    justify-content:space-between!important;
  }
  
  .staff-info, .client-confirmation{
    width:48%!important;
  }
  
  /* 容器設置 */
  .container{
    width:100%!important;
    max-width:none!important;
    margin:0!important;
    padding:0!important;
    box-shadow:none!important;
  }
  
  /* 新增：確保表格正確顯示 */
  #quoteTable {
    width: 100% !important;
    table-layout: fixed !important;
    page-break-inside: auto !important;
    border: 1px solid var(--border) !important;
  }
  
  /* 確保表格頭部在每頁都顯示 */
  #quoteTable thead {
    display: table-header-group !important;
  }
  
  /* 確保每個單元格不會被壓縮或截斷 */
  #quoteTable th, #quoteTable td {
    box-sizing: border-box !important;
    overflow: visible !important;
    page-break-inside: avoid !important;
  }
  
  /* 修復空行或被隱藏的行 */
  #itemsTableBody tr {
    display: table-row !important;
    visibility: visible !important;
    height: auto !important;
    min-height: 24px !important;
  }
  
  /* 確保空白輸入欄位仍然可見 */
  .input-field {
    background-color: transparent !important;
    border: 1px solid #e5e7eb !important;
    min-height: 18px !important;
    display: block !important;
    width: 100% !important;
  }
}`,document.head.appendChild(e)}function N(e,t='info'){if(!e)return null;const r=document.querySelector('.notification-overlay');r&&(r.classList.remove('show'),setTimeout(()=>r.remove(),300));const n=document.createElement('div');n.className=`notification-overlay notification-${t}`;let i='',s='通知';t==='warning'?(i='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#f59e0b" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>',s='注意'):t==='error'?(i='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#e53e3e" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="15" y1="9" x2="9" y2="15"></line><line x1="9" y1="9" x2="15" y2="15"></line></svg>',s='錯誤'):t==='success'?(i='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#15803d" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>',s='成功'):i='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#3b82f6" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg>',n.innerHTML=`
<div class="notification-modal">
<div class="notification-header">
<div class="notification-title">
<span class="notification-icon">${i}</span>
<span>${s}</span>
</div>
</div>
<div class="notification-content">
${e}
</div>
<div class="notification-footer">
<button class="notification-btn">我知道了</button>
</div>
</div>
`,document.body.appendChild(n),n.offsetHeight,n.classList.add('show');const c=n.querySelector('.notification-btn');c&&(c.addEventListener('click',()=>{n.classList.remove('show'),setTimeout(()=>n.remove(),300)}),setTimeout(()=>c.focus(),100));const l=e=>{(e.key==='Escape'||e.key==='Enter')&&(n.classList.remove('show'),setTimeout(()=>{n.remove(),document.removeEventListener('keydown',l)},300))};return document.addEventListener('keydown',l),n}function h(e){if(!e)return;try{const t=document.createRange(),r=window.getSelection();r&&(t.selectNodeContents(e),t.collapse(!1),r.removeAllRanges(),r.addRange(t))}catch(t){console.error('設置光標時發生錯誤:',t)}}function y(e=T,t=''){try{const r=M[e.getMonth()],n=e.getFullYear().toString().slice(-2),i=String(e.getMonth()+1).padStart(2,"0"),s=String(e.getDate()).padStart(2,"0"),c=Math.random().toString(36).substring(2,4).toUpperCase();return`${t}${r}-${n}${i}${s}${c}`}catch(r){return console.error('生成ID時發生錯誤:',r),`${t}${Math.random().toString(36).substring(2,8).toUpperCase()}`}}function E(){try{const e=d('quoteDate'),t=e?.value||T.toISOString().split("T")[0],r=new Date(t),n=d('quoteNumber');n&&(n.textContent=y(r))}catch(e){console.error('更新ID時發生錯誤:',e)}}function I(){try{const e=d('quoteDate'),t=d('quoteDateText');if(e&&t){e.value=T.toISOString().split("T")[0],t.textContent=F.formatDate(e.value);const r=new Date(e.value),n=d('quoteValidUntil'),i=d('quoteValidText');if(n&&i){const s=new Date(r);s.setDate(r.getDate()+C.DEFAULT_VALID_DAYS),n.value=s.toISOString().split("T")[0],i.textContent=F.formatDate(n.value)}const o=d('deliveryDate'),l=d('deliveryDateText');if(o&&l){const s=new Date(r);s.setDate(r.getDate()+C.DEFAULT_DELIVERY_DAYS),o.value=s.toISOString().split("T")[0],l.textContent=F.formatDate(o.value)}}}catch(e){console.error('初始化日期時發生錯誤:',e)}E()}function g(){const e=d('itemsTableBody');if(!e)return;try{e.innerHTML='';for(let t=0;t<7;t++){const r=document.createElement("tr");r.innerHTML=`
<td><input type="text" class="category-input input-field" placeholder=""></td>
<td><input type="text" class="name-input input-field" placeholder=""></td>
<td style="text-align:center">
<input type="text" class="price-input input-field" value="">
<span class="original-price"></span>
</td>
<td class="text-center"><input type="number" class="quantity-input input-field" value="" min="0" step="0.01"></td>
<td class="text-center"><input type="text" class="unit-input input-field" value=""></td>
<td class="text-center"><input type="text" class="installation-input input-field" value=""></td>
<td class="text-center"><input type="text" class="shipping-input input-field" value=""></td>
`,e.appendChild(r)}f()}catch(t){console.error('初始化表格時發生錯誤:',t)}}function v(){const e=d('itemsTableBody');if(!e)return;try{const t=document.createElement("tr");t.innerHTML=`
<td><input type="text" class="category-input input-field" placeholder=""></td>
<td><input type="text" class="name-input input-field" placeholder=""></td>
<td style="text-align:center">
<input type="text" class="price-input input-field" value="">
<span class="original-price"></span>
</td>
<td class="text-center"><input type="number" class="quantity-input input-field" value="" min="0" step="0.01"></td>
<td class="text-center"><input type="text" class="unit-input input-field" value=""></td>
<td class="text-center"><input type="text" class="installation-input input-field" value=""></td>
<td class="text-center"><input type="text" class="shipping-input input-field" value=""></td>
`,e.appendChild(t),f()}catch(t){console.error('添加行時發生錯誤:',t)}}function f(){const e=d('itemsTableBody'),t=d('subtotal'),r=d('totalShipping'),n=d('totalInstallation'),i=d('depositAmount'),s=d('grandTotal'),c=d('taxType');if(!e||!s)return;let l=0,o=0,p=0;try{Array.from(e.children).forEach(m=>{const u=m.querySelector(".price-input"),L=m.querySelector(".quantity-input"),w=m.querySelector(".shipping-input"),k=m.querySelector(".installation-input");if(!u||!L)return;const B=F.parseNumber(u.value||"0"),V=Math.max(0,F.parseNumber(L.value||"0",!1)),W=F.parseNumber(w?.value||"0"),O=F.parseNumber(k?.value||"0");l+=Math.round(B*V),o+=W,p+=O});const y=l+o+p,x=c&&c.value==="taxed",U=x?Math.round(y*C.TAX_RATE):0,R=y+U,X=Math.round(R*C.DEPOSIT_RATE);t&&(t.textContent=F.formatCurrency(l)),r&&(r.textContent=F.formatCurrency(o)),n&&(n.textContent=F.formatCurrency(p)),i&&(i.textContent=F.formatCurrency(X)),s&&(s.textContent=F.formatCurrency(R))}catch(m){console.error('計算總計時發生錯誤:',m)}}function _(e){if(!e)return;const t=e.value;if(t==='')return;try{(e.classList.contains('price-input')||e.classList.contains('shipping-input')||e.classList.contains('installation-input'))&&(t=>{const r=F.parseNumber(t);return r>C.MAX_VALUE?(N("數值超出最大限制","warning"),e.value=F.formatCurrency(C.MAX_VALUE)):r<C.MIN_VALUE?(N("數值超出最小限制","warning"),e.value=F.formatCurrency(C.MIN_VALUE)):e.value=F.formatCurrency(r),!0})(t)}catch(r){console.error('格式化輸入值時發生錯誤:',r),e.value=F.formatCurrency(0)}}function $(e){if(!e)return;try{const t=F.formatText(e.innerText.replace(/\n/g,"").trim(),e.getAttribute("data-type"));if(t===e.innerText)return;const r=window.getSelection();if(!r)return;const n=document.createRange();n.selectNodeContents(e),r.removeAllRanges(),r.addRange(n),document.execCommand("insertText",!1,t),h(e)}catch(t){console.error('處理輸入錯誤:',t)}}function q(e){e.preventDefault();const t=D[e.target.id];if(!t)return;const r=d(t);!r||('showPicker'in r?r.showPicker():(r.focus(),r.click()))}function H(e,t,r){!e||!t||e.addEventListener('change',function(){t&&(t.textContent=F.formatDate(this.value)),typeof r=='function'&&r.call(this),e.id==='quoteDate'&&E()})}function G(){const e=d('notes-textarea');e&&(S(e),e.addEventListener('input',function(){S(this)}),e.addEventListener('paste',function(){setTimeout(()=>S(this),10)}))}const j=b(()=>{const e=d('notes-textarea');e&&S(e)},50);function Q(){const e=document.querySelector('.container'),t=b(f,200),r=d('logo-container'),n=d('upload-logo');r&&n&&(r.addEventListener('click',()=>{n.value='',n.click()}),n.addEventListener('change',i=>{const s=i.target.files?.[0];if(!s)return;if(!s.type.match('image.*')){N('請選擇圖片檔案','error');return}if(s.size>2*1024*1024){N('圖片大小不能超過 2MB','error');return}const c=new FileReader;c.onload=l=>{if(!r)return;r.innerHTML='';const o=document.createElement('img');o.src=l.target?.result?.toString()||'',o.alt='公司Logo',o.style.maxHeight='50px',r.appendChild(o)},c.readAsDataURL(s)})),e.addEventListener('click',i=>{i.target.classList.contains('date-display')&&q(i)});const o=d('quoteDate'),l=d('quoteValidUntil'),p=d('deliveryDate');o&&H(o,d('quoteDateText'),function(){const i=d('quoteValidUntil'),s=d('deliveryDate'),c=new Date(this.value);if(i){const l=new Date(c);l.setDate(c.getDate()+C.DEFAULT_VALID_DAYS),i.value=l.toISOString().split("T")[0];const p=d('quoteValidText');p&&(p.textContent=F.formatDate(i.value))}if(s){const l=new Date(c);l.setDate(c.getDate()+C.DEFAULT_DELIVERY_DAYS),s.value=l.toISOString().split("T")[0];const p=d('deliveryDateText');p&&(p.textContent=F.formatDate(s.value))}}),l&&H(l,d('quoteValidText'),function(){const i=d('quoteDate');if(!i)return;const s=new Date(i.value),c=new Date(this.value);if(c<s){const l=new Date(s);l.setDate(s.getDate()+C.DEFAULT_VALID_DAYS),this.value=l.toISOString().split("T")[0],N("報價有效期不得早於報價日；系統已自動修正為預設值","warning")}}),p&&H(p,d('deliveryDateText'),function(){const i=d('quoteDate');if(!i)return;const s=new Date(i.value),c=new Date(this.value);if(c<s){const l=new Date(s);l.setDate(s.getDate()+C.DEFAULT_DELIVERY_DAYS),this.value=l.toISOString().split("T")[0],N("交期設定不得早於報價日期；系統已為您修正為預設值","warning")}});const y='[contenteditable="true"], .editable-field',x=new WeakMap;e.addEventListener('compositionstart',i=>{i.target.matches(y)&&x.set(i.target,!0)}),e.addEventListener('compositionend',i=>{i.target.matches(y)&&(x.set(i.target,!1),$(i.target))}),e.addEventListener('keypress',i=>{i.target.matches(y)&&i.key==="Enter"&&i.preventDefault()}),e.addEventListener('input',i=>{i.target.matches(y)&&!x.get(i.target)&&$(i.target)}),e.addEventListener('paste',i=>{if(i.target.matches(y)){i.preventDefault();const s=(i.clipboardData||window.clipboardData).getData("text").replace(/\n/g,"").trim();document.execCommand("insertText",!1,F.formatText(s,i.target.getAttribute("data-type"))),h(i.target)}});const U=d('quoteTable');if(U){const i='.price-input, .shipping-input, .installation-input',s=`${i}, .quantity-input`;U.addEventListener('input',c=>{c.target.matches(s)&&(c.target.matches(i)&&_(c.target),t())}),U.addEventListener('focus',c=>{c.target.tagName==='INPUT'&&c.target.select()},!0),U.addEventListener('blur',c=>{c.target.matches(i)&&_(c.target)},!0),U.addEventListener('keydown',c=>{if(c.key==='Tab'){const l=d('itemsTableBody');if(!l)return;const o=l.children;if(!o.length)return;const p=o[o.length-1];if(!p)return;const m=p.querySelector('.shipping-input');!m||c.target!==m||c.shiftKey||(c.preventDefault(),v(),setTimeout(()=>{const u=l.lastChild;if(!u)return;const L=u.querySelector('.category-input');L&&L.focus()},0))}})}const R=d('addItemBtn'),X=d('deleteItemBtn'),Y=d('taxType');R&&R.addEventListener('click',()=>{v(),j()}),X&&X.addEventListener('click',()=>{const i=d('itemsTableBody');if(!i)return;const s=i.children;s.length>1?(s[s.length-1].remove(),t(),j()):N("必須保留至少一行！","warning")}),Y&&Y.addEventListener('change',t),window.addEventListener('resize',j)}function K(){try{I(),Q(),P(),g(),f(),G(),A()}catch(e){console.error('初始化時發生錯誤:',e)}}K()});
</script>
</body>
</html>
